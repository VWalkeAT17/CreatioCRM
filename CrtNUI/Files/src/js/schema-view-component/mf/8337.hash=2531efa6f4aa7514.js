(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[8337],{98337:(H,M,l)=>{l.r(M),l.d(M,{CopilotChatMessageService:()=>oe,CopilotChatService:()=>V,CopilotFileValidatorService:()=>q,CopilotGtmService:()=>G,CopilotMentionService:()=>ge,CopilotModule:()=>Xe,CopilotService:()=>Z});var r=l(5960),I=l(3602),R=l(55642),S=l(79772),v=l(68651),b=l(67057),d=l(22307),T=l(5757),A=l(66486),L=l(13443),w=l(57852),a=l(62278),g=l(36486),E=l(82863),y=l(59969);const P=c=>c.type==="schema_saved",D=c=>[...c].sort((e,t)=>e.isCurrentUser!==t.isCurrentUser?e.isCurrentUser?-1:1:e.name.localeCompare(t.name));var W=l(5240),N=l(23092);const se="DesignerPresence";class ee{constructor(e,t,s){this._messageChannelService=e,this._userInfo=t,this._logger=s,this._usersSubject=new a.BehaviorSubject([]),this._schemaSavedSubject=new a.BehaviorSubject(null),this._currentMode="view",this.users$=this._usersSubject.asObservable(),this.schemaSaved$=this._schemaSavedSubject.asObservable(),this._currentUserId=this._normalizeGuid(this._userInfo.id),this._currentUser={id:this._currentUserId,name:this._userInfo.contactName,contactId:this._userInfo.contactId,contactName:this._userInfo.contactName,photoId:this._userInfo.photoId,mode:this._currentMode}}_normalizeGuid(e){return e?typeof e=="string"?e:typeof e.toString=="function"?e.toString():String(e):null}_setupConnection(e,t,s){const n={schemaName:e,schemaType:t,schemaCaption:s??e,senderName:this._getSenderName(e,t),subscriptions:new a.Subscription};this._connection=n,this._currentMode="view",this._clearUsers(),n.subscriptions.add(this._listenForServerEvents(n)),n.subscriptions.add(this._attachJoinTriggers(n))}_listenForServerEvents(e){return this._messageChannelService.messageEvent$.pipe((0,g.filter)(t=>!!(t?.header?.sender===e.senderName&&t?.body)),(0,g.map)(t=>t.body)).subscribe(t=>this._handlePresenceEvent(t,e))}_attachJoinTriggers(e){return(0,a.merge)(this._messageChannelService.init$.pipe((0,g.take)(1)),this._messageChannelService.reconnected$).subscribe(()=>this._sendMessage("join",e))}_handlePresenceEvent(e,t){if(P(e)){this._emitSchemaSavedEvent(e,t);return}this._emitUsers(e.users??[],t)}_emitUsers(e,t){const s=e.map(n=>this._toViewModel(n,t));this._usersSubject.next(D(s))}_emitSchemaSavedEvent(e,t){const s=this._toViewModel(e.savedBy??this._currentUser,t);this._schemaSavedSubject.next({schemaName:e.schemaName??t.schemaName,schemaType:e.schemaType??t.schemaType,schemaCaption:e.schemaCaption??t.schemaCaption,savedBy:s.name})}_toViewModel(e,t){return{id:e.id,name:e.name,contactId:e.contactId,contactName:e.contactName,photoId:e.photoId,isCurrentUser:!!(this._currentUserId&&e.id===this._currentUserId),schemaType:t.schemaType,schemaName:t.schemaName,schemaCaption:t.schemaCaption,countOfConnections:e.countOfConnections,mode:e.mode??"view"}}_createUserPayload(){return{...this._currentUser,mode:this._currentMode}}_sendMessage(e,t=this._connection){if(!t){this._logger.warn(`DesignerPresenceService: cannot send ${e} message without active connection.`);return}const s={type:e,schemaName:t.schemaName,schemaType:t.schemaType,schemaCaption:t.schemaCaption,user:this._createUserPayload()};this._messageChannelService.sendMessage(se,s,E.G.SERVER).catch(n=>this._logger.error("DesignerPresenceService: failed to send message",n))}_getSenderName(e,t){const s=e.toLowerCase(),n=String(t).toLowerCase();return`${se}_${n}_${s}`}_notifyLeave(e){const t=e??this._connection;t&&this._sendMessage("leave",t)}_teardownConnection(){this._connection?.subscriptions.unsubscribe(),this._connection=void 0}_clearUsers(){this._usersSubject.next([])}connect(e,t,s){if(!e||!t||this._connection?.schemaName===e&&this._connection?.schemaType===t)return;const n=this._connection;this._teardownConnection(),this._notifyLeave(n),this._setupConnection(e,t,s)}disconnect(){const e=this._connection;this._teardownConnection(),this._notifyLeave(e),this._clearUsers()}setMode(e){this._currentMode!==e&&(this._currentMode=e,this._connection&&this._sendMessage("join"))}saved(){this._sendMessage("schema_saved")}ngOnDestroy(){this.disconnect(),this._usersSubject.complete(),this._schemaSavedSubject.complete()}static{this.\u0275fac=function(t){return new(t||ee)(d.\u0275\u0275inject(W.A),d.\u0275\u0275inject(N.oq),d.\u0275\u0275inject(y.gP))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:ee,factory:ee.\u0275fac})}}class _e{constructor(e){this._injector=e,this._connections=new Map,this._aggregatedUsers$=new a.ReplaySubject(1),this._schemaSaved$=new a.ReplaySubject(1),this._selfModeChange$=new a.Subject,this.users$=this._aggregatedUsers$.asObservable(),this.schemaSaved$=this._schemaSaved$.asObservable(),this.selfModeChange$=this._selfModeChange$.asObservable(),this._aggregatedUsers$.next([])}_getConnectionKey(e,t){return`${t}:${e}`}_updateAggregatedUsers(){if(this._combinedSubscription?.unsubscribe(),this._savedSubscription?.unsubscribe(),this._connections.size===0){this._aggregatedUsers$.next([]);return}const e=Array.from(this._connections.values()).map(s=>s.users$);this._combinedSubscription=(0,a.combineLatest)(e).pipe((0,g.map)(s=>this._mergeAndDeduplicateUsers(s))).subscribe(s=>this._aggregatedUsers$.next(s));const t=Array.from(this._connections.values()).map(s=>s.schemaSaved$.pipe((0,g.filter)(n=>n!==null)));t.length>0&&(this._savedSubscription=(0,a.merge)(...t).subscribe(s=>this._schemaSaved$.next(s)))}_mergeAndDeduplicateUsers(e){const t=this._collectUserSchemas(e),s=[];for(const{baseUser:n,schemas:i}of t.values()){if(i.size===0){s.push(n);continue}for(const o of i.values())s.push({...n,schemaName:o.schemaName,schemaType:o.schemaType,schemaCaption:o.schemaCaption,countOfConnections:o.connections})}return this._sortUsers(s)}_collectUserSchemas(e){const t=new Map;for(const s of e)for(const n of s){const i=this._ensureUserEntry(t,n);this._addSchemaEntry(i.schemas,n)}return t}_ensureUserEntry(e,t){e.has(t.id)||e.set(t.id,{baseUser:{...t,mode:t.mode??"view"},schemas:new Map});const s=e.get(t.id);return t.mode==="edit"&&s.baseUser.mode!=="edit"&&(s.baseUser={...s.baseUser,mode:"edit"}),s}_addSchemaEntry(e,t){if(!t.schemaName||!t.schemaType)return;const s=`${t.schemaType}:${t.schemaName}`,n=t.countOfConnections??1,i=e.get(s);if(i){i.connections+=n,t.schemaCaption&&!i.schemaCaption&&(i.schemaCaption=t.schemaCaption);return}e.set(s,{schemaName:t.schemaName,schemaType:t.schemaType,schemaCaption:t.schemaCaption,connections:n})}_sortUsers(e){return D(e)}connect(e,t,s){const n=this._getConnectionKey(e,t);if(this._connections.has(n))return;const o=d.Injector.create({providers:[ee],parent:this._injector}).get(ee);o.connect(e,t,s),this._connections.set(n,o),this._updateAggregatedUsers()}onSaved(e,t){const s=this._getConnectionKey(e,t),n=this._connections.get(s);n&&n.saved()}setMode(e,t,s){const n=this._getConnectionKey(e,t),i=this._connections.get(n);i&&(i.setMode(s),this._selfModeChange$.next({schemaName:e,schemaType:t,mode:s}))}disconnect(e,t){const s=this._getConnectionKey(e,t),n=this._connections.get(s);n&&(n.disconnect(),n.ngOnDestroy(),this._connections.delete(s),this._updateAggregatedUsers())}disconnectAll(){for(const e of this._connections.values())e.disconnect(),e.ngOnDestroy();this._connections.clear(),this._updateAggregatedUsers()}ngOnDestroy(){this.disconnectAll(),this._combinedSubscription?.unsubscribe(),this._savedSubscription?.unsubscribe(),this._aggregatedUsers$.complete(),this._schemaSaved$.complete(),this._selfModeChange$.complete()}static{this.\u0275fac=function(t){return new(t||_e)(d.\u0275\u0275inject(d.Injector))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:_e,factory:_e.\u0275fac})}}var F=l(28399);const gs=new d.InjectionToken("OptionsSkipUnsuccessfulResponseHandling"),_s=new d.InjectionToken("SchemaDesignerApiUrl"),Cs=new d.InjectionToken("SchemaDesignerConverter");var x=l(6530),De=l(26594);function fs(){return`BusinessRule_${(0,x.qv)().substring(0,7)}`}var Ne;(function(c){c.BusinessRule="BusinessRule",c.RelatedPage="RelatedPage",c.TimelineEntity="TimelineEntity",c.AppearanceSettings="AppearanceSettings",c.Sidebar="Sidebar",c.UCTestAddon="UCTestAddon",c.MobileRelatedPage="MobileRelatedPage"})(Ne||(Ne={}));var ln=l(26544);class Ze extends ln.D{constructor(e){super(e),this.typeName="Terrasoft.Core.Addons.AddonSchema",this.metaData=e.metaData,this.addonName=e.addonName,this.targetSchemaUId=e.targetSchemaUId,this.targetSchemaManagerName=e.targetSchemaManagerName,this.typeName=e.typeName,this.id=e.id,this.parentSchemaUId=e.parentSchemaUId,this.package=e.package,this.resources=e.resources,this.useFullHierarchy=e.useFullHierarchy}clone(){return new Ze(this)}set addonConfig(e){this.metaData=JSON.stringify(e,null,"	")}get addonConfig(){try{return JSON.parse(this.metaData)}catch{throw new Error("Invalid addon JSON metadata received from server")}}equal(e){return this.metaData===e.metaData&&this.addonName===e.addonName&&this.targetSchemaManagerName===e.targetSchemaManagerName&&this.targetSchemaUId===e.targetSchemaUId&&this.typeName===e.typeName&&this.extendParent===e.extendParent&&this.uId===e.uId&&this.name===e.name&&this.packageUId===e.packageUId&&this.caption===e.caption&&this.id===e.id&&this.parentSchemaUId===e.parentSchemaUId}}class Le{constructor(...e){if(this._isLoaded=!1,this._isChanged=!1,this.id=(0,x.qv)(),e[0]instanceof Le){const t=e[0];this.addonName=t.addonName,this._targetSchemaUId=t.targetSchemaUId,this.targetSchemaManagerName=t.targetSchemaManagerName,this.targetParentSchemaUId=t.targetParentSchemaUId,this.targetPackageUId=t.targetPackageUId,this.id=t.id,this._apiService=t._apiService,this._isLoaded=t._isLoaded,this._isChanged=t._isChanged,t._schema&&(this._schema=t._schema.clone()),this.useFullHierarchy=t.useFullHierarchy}else this.addonName=e[0],this._targetSchemaUId=e[1],this.targetParentSchemaUId=e[2],this.targetPackageUId=e[3],this.targetSchemaManagerName=e[4],this._apiService=e[5],this.useFullHierarchy=e[6]}get schema$(){return this._isLoaded?(0,a.of)(this._schema):this._loadSchema()}get isChanged(){return this._isChanged}get resources(){return this._resources}get targetSchemaUId(){return this._targetSchemaUId}set targetSchemaUId(e){this._targetSchemaUId=e,this._schema&&(this._schema.targetSchemaUId=e)}get addonConfig(){return this.schema$.pipe((0,g.map)(e=>{const t=e.addonConfig;return this._setMetadataDefValues(t),t}))}set addonConfig(e){(0,a.forkJoin)([this.schema$,e]).subscribe(([t,s])=>{t.addonConfig=s,this._isChanged=!0})}_setMetadataDefValues(e){this.addonName===Ne.BusinessRule&&e.rules?.forEach(s=>{s.name=s.name||fs(),s.enabled=s.enabled||s.enabled===void 0})}_setAddonResources(e){this._resources=e.map(t=>{const s=t.key.split(".");return{key:[s[2],s[3]].join("."),value:t.value}}),this._schema.resources=[...this._resources]}_loadSchema(){return this._schema$?this._schema$:(this._schema$=this._apiService.getAddon({targetSchemaUId:this.targetSchemaUId,addonName:this.addonName,targetParentSchemaUId:this.targetParentSchemaUId,targetPackageUId:this.targetPackageUId,targetSchemaManagerName:this.targetSchemaManagerName,useFullHierarchy:this.useFullHierarchy}).pipe((0,g.tap)(e=>{e.success&&(this._schema=new Ze(e.schema),this._schema.typeName="Terrasoft.Core.Addons.AddonSchema",this._isLoaded=!0,this._setAddonResources(e.schema.resources??[]))}),(0,g.map)(()=>this._schema),(0,g.share)()),this._schema$)}save(){return this._isLoaded?this._apiService.saveAddon(this._schema).pipe((0,g.map)(e=>e.success),(0,g.tap)(()=>{this._isChanged=!1})):(0,a.of)(!0)}clone(){return new Le(this)}equal(e){let t=this._isLoaded===e._isLoaded&&e.targetSchemaUId===this.targetSchemaUId&&e.addonName===this.addonName&&this.targetSchemaManagerName===e.targetSchemaManagerName;return t&&this._isLoaded&&(t=this._schema.equal(e._schema)),t}createOrUpdateResource(e){const t=this.resources.findIndex(s=>s.key===e.key);t===-1?this.resources.push(e):this.resources.splice(t,1,e),this._schema.resources=[...this._resources]}removeResource(e){const t=this.resources.findIndex(s=>s.key===e);this.resources.splice(t,1),this._schema.resources=[...this._resources]}}class Ce{constructor(e){this._httpClient=e,this._workplaceServiceUrl="/rest/WorkplaceService/"}resetWorkplaceScriptCache(){const e=this._workplaceServiceUrl+"ResetScriptCache";return this._httpClient.post(e,null)}static{this.\u0275fac=function(t){return new(t||Ce)(d.\u0275\u0275inject(T.HttpClient))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:Ce,factory:Ce.\u0275fac,providedIn:"root"})}}class ce{constructor(e){this.getAddonMethodName="GetSchema",this.getAddonMetadataMethodName="GetSchemaMetadata",this.saveAddonMethodName="SaveSchema",this.serviceEndpoint="/ServiceModel/AddonSchemaDesignerService.svc/",this._httpClient=e.get(T.HttpClient),this._workplaceService=e.get(Ce)}getAddon(e){const t=`${this.serviceEndpoint}${this.getAddonMethodName}`;return this._httpClient.post(t,e)}getAddonMetadata(e){const t=`${this.serviceEndpoint}${this.getAddonMetadataMethodName}`;return this._httpClient.post(t,e)}saveAddon(e){const t=`${this.serviceEndpoint}${this.saveAddonMethodName}`;return this._httpClient.post(t,e).pipe((0,a.switchMap)(s=>this._workplaceService.resetWorkplaceScriptCache().pipe((0,g.map)(()=>s))))}static{this.\u0275fac=function(t){return new(t||ce)(d.\u0275\u0275inject(d.Injector))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:ce,factory:ce.\u0275fac})}}class le{constructor(e){this._apiService=e.get(ce),this._features=e.get(De.G,{optional:!0})}_getParentSchemaUId(e){const t=e.parentSchema??e.parent;return t?.name===e.name?t.uId:x.To}create(e,t){return!e.addonTypes||e.addonTypes.length===0?[]:e.addonTypes.map(s=>{const n=this._getParentSchemaUId(e);return this.createAddonInfo(e,s,n,t)})}createAddonInfo(e,t,s,n){return new Le(t,e.uId,s,e.package.uId,n,this._apiService,e.useFullHierarchy)}static{this.\u0275fac=function(t){return new(t||le)(d.\u0275\u0275inject(d.Injector))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:le,factory:le.\u0275fac})}}const dn=c=>`/ServiceModel/${c}/`,hn=(c,e)=>({multi:!1,provide:e,useValue:dn(c)}),un=c=>hn(c,_s);class fe extends A.t{get converter(){return this._converter}constructor(e){super(),this._restErrorHandleOptions={},this.createNewSchemaMethodName="CreateNewSchema",this.getSchemaMethodName="GetSchema",this.saveSchemaMethodName="SaveSchema",this.serviceEndpoint=e.get(_s),this._converter=e.get(Cs,null,{optional:!0}),this._addonInfoFactory=e.get(le),this._errorHandler=e.get(L.x),this._designerPresenceManager=e.get(_e,null,{optional:!0}),this._resourceFinderService=e.get(w.Q),this._restErrorHandleOptions.skipUnsuccessfulResponse=e.get(gs,!1,{optional:!0})}_connectToPresence(e){const t=this.getSchemaType();if(!this._designerPresenceManager||!e?.id||!t)return;const s=this._resolveSchemaCaption(e)??e.name;this._designerPresenceManager.connect(e.name,t,s)}_resolveSchemaCaption(e){return this._isLocalizableSchema(e)?this._resourceFinderService.findLocalizableValue(e.caption):null}_isLocalizableSchema(e){return!!(e&&"caption"in e&&e.caption)}_addonSaveHandler(e){const t=e.save();return this._errorHandler.handleRequest(t,this._restErrorHandleOptions).pipe((0,g.catchError)(()=>(0,a.of)(!1)),(0,g.map)(s=>({message:`Addon ${e.addonName} was ${s?"successfully":"not"} saved!`,result:s})))}_saveAddons(e){return(0,a.forkJoin)(e.map(t=>this._addonSaveHandler(t))).pipe((0,g.map)(t=>{const s=t.filter(n=>!n.result).map(n=>n.message);return s.length>0?s:null}))}getSchemaManagerName(){return null}getSchemaType(){return null}getSchemaFromService(e,t,s=!1){const n=s?{headers:new T.HttpHeaders({"Content-Type":"application/json"})}:{};return this.httpClient.post(e,t,n).pipe((0,g.map)(i=>{if(i.schema){const o=this.getSchemaManagerName();return i.schema=this.convertToObject(i.schema),i.schema.addons=this._addonInfoFactory.create(i.schema,o),i}return i}),(0,g.tap)(i=>{i.schema&&this._connectToPresence(i.schema)}),(0,g.share)())}getSchemasFromService(e,t,s=!1){const n=s?{headers:new T.HttpHeaders({"Content-Type":"application/json"})}:{};return this.httpClient.post(e,t,n).pipe((0,g.map)(i=>{if(i.schemas){const o=this.getSchemaManagerName();for(const p of i.schemas){const u=i.schemas.indexOf(p);i.schemas[u]=this.convertToObject(p),i.schemas[u].addons=this._addonInfoFactory.create(p,o)}return i}return i}),(0,g.share)())}createObject(e,t){return Object.assign(new e,t)}convertToObject(e){return this._converter.convertToSchema(e)}convertSchemaToDTO(e){return e}createSchema(e){const t=`${this.serviceEndpoint}${this.createNewSchemaMethodName}`;return this.getSchemaFromService(t,e)}getSchema(e){const t=`${this.serviceEndpoint}${this.getSchemaMethodName}`;return this.getSchemaFromService(t,e)}saveSchema(e,t=!1){t&&(e.useFullHierarchy=!0);const s=`${this.serviceEndpoint}${this.saveSchemaMethodName}`,n=e.addons?[...e.addons]:null,i=(0,F.omit)(e,["addons"]),o=this.httpClient.post(s,i);return this._errorHandler.handleRequest(o,this._restErrorHandleOptions).pipe((0,g.concatMap)(u=>{const m=n?.filter(_=>_.isChanged);return u.success&&m?.length>0?this._saveAddons(m).pipe((0,g.map)(_=>({...u,addonsErrors:_}))):(0,a.of)(u)}),(0,g.tap)(u=>{if(u.success&&this._designerPresenceManager&&e?.name){const m=this.getSchemaType();m&&this._designerPresenceManager.onSaved(e.name,m)}}),(0,g.share)())}checkUniqueSchemaName(e,t,s){const n=this.serviceEndpoint+"CheckUniqueSchemaName",i={schemaName:e,excludeUId:t,managerName:s};return this.httpClient.post(n,i,{headers:new T.HttpHeaders({"Content-Type":"application/json"})}).pipe((0,g.share)())}static{this.\u0275fac=function(t){return new(t||fe)(d.\u0275\u0275inject(d.Injector))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:fe,factory:fe.\u0275fac,providedIn:"root"})}}class Ss{copy(e){return{...e}}isEmpty(e){return!1}}var we=l(78868);class Se{constructor(e){this.typeName="Terrasoft.Core.BusinessRules.Models.Conditions.BaseBusinessRuleDesignCondition",e?this.uId=e?.uId:this.uId=(0,x.qv)()}toMetadata(){return{typeName:this.typeName,uId:this.uId}}copy(){return new Se({...this.toMetadata(),uId:(0,x.qv)()})}isValid(){return!!this.uId}onDataSourceAttributeNameChanged(e,t,s){}isAttributeUsed(e,t){return!1}getWarningMessages(){return[]}hasScopeAttributes(e){return!1}}class $e extends Se{}var pn=l(7748),Ye=l(6553),qe;(function(c){c[c.None=0]="None",c[c.And=1]="And",c[c.Or=2]="Or"})(qe||(qe={}));var $=l(86464),K;(function(c){c[c.IsNull=0]="IsNull",c[c.IsNotNull=1]="IsNotNull",c[c.Equal=2]="Equal",c[c.NotEqual=3]="NotEqual",c[c.Less=5]="Less",c[c.LessOrEqual=6]="LessOrEqual",c[c.Greater=7]="Greater",c[c.GreaterOrEqual=8]="GreaterOrEqual",c[c.Contain=11]="Contain",c[c.NotContain=12]="NotContain"})(K||(K={}));var de=l(47149),mn=l(16091),vs=l(67706);class Fe extends Se{constructor(e){super(e),this._businessRuleDesignExpressionFactory=new mn.T,this.typeName="Terrasoft.Core.BusinessRules.Models.Conditions.BusinessRuleCondition",this.comparisonType=K.IsNull,e&&(e.leftExpression&&(this.leftExpression=this._businessRuleDesignExpressionFactory.get(e.leftExpression)),e.rightExpression&&(this.rightExpression=this._businessRuleDesignExpressionFactory.get(e.rightExpression)),e.comparisonType!=null&&(this.comparisonType=e.comparisonType))}toMetadata(){return{...super.toMetadata(),leftExpression:this.leftExpression?.toMetadata(),rightExpression:this.rightExpression?.toMetadata(),comparisonType:this.comparisonType}}copy(){const e=new Fe({...this.toMetadata(),uId:(0,x.qv)()});return e.leftExpression=this.leftExpression?.copy(),e.rightExpression=this.rightExpression?.copy(),e}isValid(){if(!super.isValid()||this.comparisonType==null)return!1;const e=!!this.leftExpression?.isValid();switch(this.comparisonType){case K.IsNull:case K.IsNotNull:return e;case K.Equal:case K.NotEqual:return e&&!!this.rightExpression?.isValid();default:return!0}}onDataSourceAttributeNameChanged(e,t,s){this.leftExpression.onDataSourceAttributeNameChanged(e,t,s),this.rightExpression?.onDataSourceAttributeNameChanged(e,t,s)}_getAttributeExpressionWarningMessage(e){if(!e.dataValueTypeName)return null;const t=Object.values(de.Q).find(s=>s.name===e.dataValueTypeName)?.type;return t===$.r.MAXSIZE_TEXT?{message:"BusinessRules.Errors.MaxSizeInConditionLimitedWarningMessage",type:"warn"}:t===$.r.RICH_TEXT||t===$.r.Image?{message:"BusinessRules.Errors.NotSupportedInConditionTypesWarningMessage",type:"error"}:null}getWarningMessages(){const e=[];if(this.comparisonType===K.Equal||this.comparisonType===K.NotEqual){if(this.leftExpression instanceof vs.b){const t=this._getAttributeExpressionWarningMessage(this.leftExpression);t&&e.push(t)}if(this.rightExpression instanceof vs.b){const t=this._getAttributeExpressionWarningMessage(this.rightExpression);t&&e.push(t)}}return e}isAttributeUsed(e,t){return this.leftExpression?.isAttributeUsed(e,t)||this.rightExpression?.isAttributeUsed(e,t)}hasScopeAttributes(e){return this.leftExpression?.hasScopeAttributes(e)||this.rightExpression?.hasScopeAttributes(e)}}class Ue extends Se{constructor(e){super(e),this.typeName=Ye.W,this.logicalOperation=qe.And,this.conditions=[],e&&(this.logicalOperation=e.logicalOperation,this.conditions=e.conditions?.map(t=>t.typeName===Ye.W?new Ue(t):new Fe(t))??[])}_copyConditions(){return this.conditions.map(e=>e.copy())}toMetadata(){return{...super.toMetadata(),logicalOperation:this.logicalOperation,conditions:this.conditions.map(e=>e.toMetadata())}}copy(){const e=new Ue({...this.toMetadata(),uId:(0,x.qv)()});return e.conditions=this._copyConditions(),e}isValid(){return super.isValid()&&this.conditions?this.conditions.length===0?!0:this.conditions.every(t=>t.isValid()):!1}onDataSourceAttributeNameChanged(e,t,s){this.conditions.forEach(n=>n.onDataSourceAttributeNameChanged(e,t,s))}isAttributeUsed(e,t){return this.conditions.some(s=>s.isAttributeUsed(e,t))}getWarningMessages(){return this.conditions.map(e=>e.getWarningMessages()).flat()}hasScopeAttributes(e){return this.conditions.some(t=>t.hasScopeAttributes(e))}}class gn{get(e){return e.typeName===Ye.W?new Ue(e):new Fe(e)}}class Ve{get actions(){return Object.freeze(this._actions)}constructor(e){this._businessRuleDesignActionFactory=new pn.J,this._businessRuleDesignConditionFactory=new gn,this._typeName="Terrasoft.Core.BusinessRules.Models.BusinessRuleCase",this._actions=[],this.uId=e?.uId||(0,x.qv)(),e?.condition?this.condition=this._businessRuleDesignConditionFactory.get(e.condition):this.condition=new $e,e?.actions?.forEach(t=>{this._actions.push(this._businessRuleDesignActionFactory.get(t))})}_getActionIndex(e){return this.actions.findIndex(t=>t.uId===e.uId)}_actionsUpdateMetadata(e){const t=[];e.actions.forEach(n=>{t.push(n.uId);const i=this._businessRuleDesignActionFactory.get(n);this._getActionIndex(i)!==-1?this.updateAction(i):this.addAction(i)}),this.actions.filter(n=>!t.includes(n.uId)).forEach(n=>this.deleteAction(n))}_getActionsMetadata(){return this.actions.map(e=>e.toMetadata())}_getConditionMetadata(){const e=this.condition;return e&&!(e instanceof $e)?e.toMetadata():null}_copyActions(){return this.actions.map(e=>e.copy())}_setActions(e){this._actions=[...e]}_copyCondition(){const e=this.condition;return e&&!(e instanceof $e)?e.copy():new $e}toMetadata(){const e=this._getConditionMetadata(),t=this._getActionsMetadata();return{typeName:this._typeName,uId:this.uId,condition:e,actions:t}}updateFromMetadata(e){e.condition&&this.updateCondition(this._businessRuleDesignConditionFactory.get(e.condition)),this._actionsUpdateMetadata(e)}addAction(e){if(this._getActionIndex(e)!==-1){console.warn(`Action ${e.uId} already exists`);return}this._actions=[...this._actions,e.clone()]}updateAction(e){const t=this._getActionIndex(e);if(t===-1){console.warn(`Action ${e.uId} not found`);return}this._actions=[...this._actions],this._actions.splice(t,1,e.clone())}deleteAction(e){const t=this._getActionIndex(e);t<0||(this._actions=[...this._actions],this._actions.splice(t,1))}updateCondition(e){this.condition=e}copy(){const e=new Ve({...this.toMetadata(),uId:(0,x.qv)()});return e._setActions(this._copyActions()),e.condition=this._copyCondition(),e}onDataSourceAttributeNameChanged(e,t,s){this.condition.onDataSourceAttributeNameChanged(e,t,s),this._actions.forEach(n=>n.onDataSourceAttributeNameChanged(e,t,s))}isAttributeUsed(e,t){return this.condition.isAttributeUsed(e,t)||this._actions.some(s=>s.isAttributeUsed(e,t))}hasScopeAttributes(e){return this.condition.hasScopeAttributes(e)||this._actions.some(t=>t.hasScopeAttributes(e))}}var ys=l(92499);function _n(c,e){return Object.values(c).indexOf(e)}class Oe{constructor(e){this._typeName="Terrasoft.Core.BusinessRules.Models.Trigger",this.name="",this.type=we.T.ChangeAttributeValue,this.scopeId="",this.uId=e?.uId||(0,x.qv)(),e&&(this.name=e.name,this.type=Object.values(we.T)[e.type||0],this.scopeId=e.scopeId)}toMetadata(){const e=_n(we.T,this.type);return{typeName:this._typeName,uId:this.uId,name:this.name,type:e,scopeId:this.scopeId}}copy(){return new Oe({...this.toMetadata(),uId:(0,x.qv)()})}isAttributeUsed(e,t){return this.name===t&&(0,ys.t4)(this.scopeId,e)}hasScopeAttributes(e){return(0,ys.t4)(this.scopeId,e)}}class He{get hasWarnings(){return this.getWarningMessages().length>0}constructor(e,t,s,n,i){this.caption=t,this.schemaName=s,this.schemaCaption=n,this.applicabilityType=i,this._typeName="Terrasoft.Core.BusinessRules.BusinessRule",this.name="",this.enabled=!0,this.triggers=[],this.cases=[],this.needToSave=!1,this.parentUId="",this.parentActionUId="",this.uId=e.uId,this.updateFromMetadata(e)}_updateCase(e){const t=this.cases.find(s=>s.uId===e.uId);if(t){t.updateFromMetadata(e);return}this.addCase(new Ve(e))}_casesUpdateMetadata(e){const t=[];e.cases?.forEach(s=>{t.push(s.uId),this._updateCase(s)}),this.cases=this.cases.filter(s=>t.includes(s.uId))}_copyCases(){return this.cases?.map(e=>e.copy())}_copyTriggers(){return this.triggers?.map(e=>e.copy())}_isValidCaption(){return this.caption.some(e=>e.value)}addTrigger(e,t,s=""){const n=Object.values(we.T).indexOf(t),i=new Oe({name:e,type:n,scopeId:s});return this.triggers.push(i),i.uId}addCase(e){this.cases.push(e)}getFirstCase(){let e=this.cases[0];return e||(e=new Ve,this.addCase(e),this.getFirstCase())}updateFromMetadata(e){this.parentUId=e.parentUId??"",this.parentActionUId=e.parentActionUId??"",this.name=e.name,this.enabled=e.enabled,this._casesUpdateMetadata(e),this.triggers=e.triggers?.map(t=>new Oe(t))??[]}toMetadata(){const e={typeName:this._typeName,uId:this.uId,cases:this.cases.map(t=>t.toMetadata()),triggers:this.triggers.map(t=>t.toMetadata()),name:this.name,enabled:this.enabled};return this.parentUId&&(e.parentUId=this.parentUId),this.parentActionUId&&(e.parentActionUId=this.parentActionUId),e}clone(){const e=new He(this.toMetadata(),this.caption.clone(),this.schemaName,this.schemaCaption,this.applicabilityType);return e.needToSave=this.needToSave,e}copy(){const e=this.caption.clone();e.forEach(s=>{s.value&&(s.value=`Copy ${s.value}`)});const t=new He({...this.toMetadata(),uId:(0,x.qv)()},e,this.schemaName,this.schemaCaption,this.applicabilityType);return t.name=fs(),t.cases=this._copyCases(),t.triggers=this._copyTriggers(),t}isValid(){if(!this._isValidCaption())return!1;const t=this.getFirstCase(),s=t?.condition,n=t?.actions;return s?.isValid()&&n?.length>0&&n.every(i=>i.isValid())}showInvalid(){return this.needToSave?!this.isValid():!1}onDataSourceAttributeNameChanged(e,t,s){this.cases.forEach(n=>n.onDataSourceAttributeNameChanged(e,t,s))}getWarningMessages(){const e=[],s=this.getFirstCase()?.condition;return s&&e.push(...s.getWarningMessages()),e}isAttributeUsed(e,t){return this.cases.some(s=>s.isAttributeUsed(e,t))||this.triggers.some(s=>s.isAttributeUsed(e,t))}hasScopeAttributes(e){return this.cases.some(t=>t.hasScopeAttributes(e))||this.triggers.some(t=>t.hasScopeAttributes(e))}}var U=l(50588);class Cn extends Ss{copy(e){const t=e.metadata,s=[],n=[];return t.rules.forEach(i=>{const o=new He(i,new U.h,null,null,null),{uId:p,name:u}=o,m=o.copy();m.name=u;const _=m.uId,O=(e.resources||[]).find(re=>re.key?.includes(p));if(O){const re=O.key.replace(p,_);n.push({...O,key:re})}s.push(m.toMetadata())}),{metadata:{...e.metadata,rules:s},name:e.name,resources:n}}isEmpty(e){return!e.metadata?.rules||e.metadata.rules?.length===0}}class ve{create(e){return e===Ne.BusinessRule?new Cn:new Ss}static{this.\u0275fac=function(t){return new(t||ve)}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:ve,factory:ve.\u0275fac})}}class he{static{this.\u0275fac=function(t){return new(t||he)}}static{this.\u0275mod=d.\u0275\u0275defineNgModule({type:he})}static{this.\u0275inj=d.\u0275\u0275defineInjector({providers:[ce,le,ve],imports:[b.CommonModule]})}}(function(){(typeof ngJitMode>"u"||ngJitMode)&&d.\u0275\u0275setNgModuleScope(he,{imports:[b.CommonModule]})})();var fn=l(82898),Sn=l(49973),vn=l(34251),yn=l(36592),In=l(65751);class ye{constructor(e){this._httpClient=e,this._appPackagesServiceUrl="ServiceModel/ApplicationPackagesService.svc/",this._getDesignPackageUId="GetDesignPackageUId"}getDesignPackageUId(e,t){const s=`${this._appPackagesServiceUrl}${this._getDesignPackageUId}`;return this._httpClient.post(s,{schemaUId:e,userLevelSchema:t})}static{this.\u0275fac=function(t){return new(t||ye)(d.\u0275\u0275inject(T.HttpClient))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:ye,factory:ye.\u0275fac,providedIn:"root"})}}class je{constructor(e,t){this.name=e,this.uId=t}equal(e){return e==null?!1:this.uId===e.uId&&this.name===e.name&&this.type===e.type&&this.isChanged===e.isChanged&&this.isLocked===e.isLocked}clone(){const e=new je(this.name,this.uId);return e.type=this.type,e.isChanged=this.isChanged,e.isLocked=this.isLocked,e}}class Ie extends Array{constructor(e){super(),e&&Array.isArray(e)&&(this.push(...e.map(t=>t.clone())),this.uId=e.uId),this.uId=this.uId||(0,x.qv)()}deleteItemByUId(e){const t=this.findItemIndex(e);return t<0?!1:(this.splice(t,1),!0)}findItemIndex(e){return this.findIndex(t=>t.uId===e)}findItem(e){return this.find(t=>t.uId===e)}addItem(e){this.unshift(e)}reloadAll(e){this.splice(0,this.length,...e||[])}equal(e){return e==null||this.length!==e?.length?!1:this.every(t=>{const s=e?.findItem(t.uId);return t.equal(s)})}clone(){return new Ie(this)}getLocalizableValues(e,t){this.forEach(s=>{const n={};s.getLocalizableValues(n),Object.entries(n).forEach(([i,o])=>{e[`${t}.${s.name}.${i}`]=o})})}loadLocalizableValues(e,t,s=!1){const n={};Object.entries(e).map(([i,o])=>{const p=i.split("."),u=p.shift(),m=p.shift(),_=p.join(".");return{itemGroupName:u,itemName:m,itemResourceName:_,values:o}}).filter(({itemGroupName:i})=>i===t).forEach(({itemName:i,itemResourceName:o,values:p})=>{const u=n[i]??{};u[o]=p,n[i]=u}),Object.entries(n).forEach(([i,o])=>{this.find(u=>u.name===i).loadLocalizableValues(o,s)})}}var Mn=l(37827);class An{constructor(e){this.factory=e}createSchema(e){const t=new this.factory;return Object.assign(t,e),e.package&&(t.package=new je(e.package.name,e.package.uId),t.package.type=e.package.type,t.package.isChanged=e.package.isChanged,t.package.isLocked=e.package.isLocked),t}createLocalizableStrings(e){if(!e)return new Ie;const t=e.map(s=>new Mn.e(s));return new Ie(t)}}var Is=l(44462),Ms=l(63740);class En extends Ms.p{constructor(e){if(super(e),this.isReadOnly=!1,this.useFullHierarchy=!1,this.userLevelSchema=!1,this.addonTypes=[],this.addons=[],e){if(this.id=e.id,e.package){const t=e.package;t.clone?this.package=t.clone():(this.package=new je(t.name,t.uId),this.package.type=t.type,this.package.isChanged=t.isChanged,this.package.isLocked=t.isLocked)}if(this.body=e.body,this.isReadOnly=e.isReadOnly,this.useFullHierarchy=e.useFullHierarchy,this.parentSchema=e.parentSchema,this.extendParent=e.extendParent,e.dependencies){const t=e.dependencies;let s=t.requiredSchemas;s&&(s=[...s]);let n=t.requiredEntityColumns;n&&(n=n.map(i=>({entitySchemaName:i.entitySchemaName,columnPaths:[...i.columnPaths]}))),this.dependencies={requiredSchemas:s,requiredEntityColumns:n}}}}updateDescription(e){super.update(e),this.id=e.id,this.package=e.package}equal(e){if(e==null)return!1;let t=super.equal(e)&&this.id===e.id&&this.body===e.body&&this.isReadOnly===e.isReadOnly&&this.useFullHierarchy===e.useFullHierarchy;return(this.package||e.package)&&(t=t&&this.package?.equal(e.package)),t}getLocalizableValues(e){super.getLocalizableValues(e)}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t)}}class et extends En{constructor(e){super(e),this.caption=new U.h,this.localizableStrings=new Ie,this.description=new U.h,e&&(this.caption=e.caption?e.caption.clone():e.caption,this.description=e.description?e.description.clone():e.description,this.localizableStrings=e.localizableStrings?e.localizableStrings.clone():e.localizableStrings)}get DefaultName(){return"BaseSchema"}findChildrenItem(e){return this.localizableStrings.findItem(e)}findGroup(e){return this.localizableStrings.uId===e?this.localizableStrings:null}updateDescription(e){super.updateDescription(e),this.caption=new U.h(e.caption),this.description=new U.h(e.description)}equal(e){return e==null?!1:super.equal(e)&&(0,Is.$n)(this.caption,e.caption,!0)&&(0,Is.$n)(this.description,e.description,!0)}clone(){return new et(this)}getLocalizableValues(e){super.getLocalizableValues(e),e.caption=this.caption.clone(),e.description=this.description.clone(),this.localizableStrings.getLocalizableValues(e,"localizableStrings")}loadLocalizableValues(e,t=!1){super.loadLocalizableValues(e,t),this.caption.setValues(e.caption,t),this.description.setValues(e.description,t),this.localizableStrings.loadLocalizableValues(e,"localizableStrings",t)}getIsOwnMetaItem(e){return this.uId===e.parentSchemaUId}}class As extends et{}class Pn{constructor(){this.caption=new U.h,this.description=new U.h,this.isConfirmRequired=!1}}class xn extends Ms.p{constructor(){super(...arguments),this.caption=new U.h}}class ne extends An{constructor(e,t){super(As),this._userInfo=e,this._resourceFinderService=t,this._sysCultureName=this._userInfo.cultureInfo.sysCultureName}_convertSchemaActionToDto(e,t){return t.actions?.map(s=>({Id:s.uid,Code:s.name,Intent:{value:e},ActionType:s.actionSchemaTypeUId,Name:this._resourceFinderService.findLocalizableValue(s.caption),Description:this._resourceFinderService.findLocalizableValue(s.description),Params:s.params,PackageUId:t.package.uId,IsConfirmRequired:s.isConfirmRequired}))}_convertSchemaParametersToDto(e,t,s){return t.map(n=>({UId:n.uId,Intent:{value:e},Name:this._resourceFinderService.findLocalizableValue(n.caption),Code:n.name,Description:n.description,SourceCollection:s,DataValueTypeUId:n.dataValueTypeUId}))}_convertDtoActionToSchema(e,t){const s=e.actions||[],i=t.filter(u=>s.every(m=>m.uid!==u.Id)).map(u=>{const m=new Pn;return m.uid=u.Id,m.name=u.Code,m.params=u.Params,m.isConfirmRequired=u.IsConfirmRequired,m.actionSchemaTypeUId=u.ActionType,m.caption.setValueLocalizableString(this._sysCultureName,u.Name),m.description.setValueLocalizableString(this._sysCultureName,u.Description),m}),p=s.filter(u=>t.some(m=>m.Id===u.uid)).map(u=>{const m=t.find(_=>_.Id===u.uid);return u.name=m.Code,u.caption.setValueLocalizableString(this._sysCultureName,m.Name),u.description.setValueLocalizableString(this._sysCultureName,m.Description),u.params=m.Params,u.actionSchemaTypeUId=m.ActionType,u.isConfirmRequired=m.IsConfirmRequired,u});e.actions=[...i,...p]}_convertDtoParametersToSchema(e,t,s){const n=e[t]||[],o=s.filter(m=>n.every(_=>_.uId!==m.UId)).map(m=>{const _=new xn;return _.uId=m.UId,_.name=m.Code,_.caption.setValueLocalizableString(this._sysCultureName,m.Name),_.description=m.Description,_.dataValueTypeUId=m.DataValueTypeUId,_}),u=n.filter(m=>s.some(_=>_.UId===m.uId)).map(m=>{const _=s.find(O=>O.UId===m.uId);return m.name=_.Code,m.caption.setValueLocalizableString(this._sysCultureName,_.Name),m.description=_.Description,m.dataValueTypeUId=_.DataValueTypeUId,m});e[t]=[...o,...u]}_mapActions(e){return e?.map(t=>(t.description=new U.h(t.description),t.caption=new U.h(t.caption),t.isConfirmRequired=!!t.isConfirmRequired,t))}_mapParameters(e){return e?.map(t=>(t.caption=new U.h(t.caption),t))}_convertDtoSubIntentsToSchema(e,t){const s=e.subIntents||[],i=t.filter(u=>s.every(m=>m.uId!==u.UId)).map(u=>{const m=new As;return m.uId=u.UId,m.name=u.Code,m.description.setValueLocalizableString(this._sysCultureName,u.Description),m.caption.setValueLocalizableString(this._sysCultureName,u.Title),m}),p=s.filter(u=>t.some(m=>m.UId===u.uId)).map(u=>{const m=t.find(_=>_.UId===u.uId);return u.name=m.Code,u.description.setValueLocalizableString(this._sysCultureName,m.Description),u.caption.setValueLocalizableString(this._sysCultureName,m.Title),u});e.subIntents=[...i,...p]}_mapSubIntents(e){return e?.map(t=>(t.caption=new U.h(t.caption),t.description=new U.h(t.description),t))}_convertSchemaSubIntentsToDto(e){return e.subIntents?.map(t=>this.schemaToModel(t.uId,t))??[]}createSchema(e){const t=super.createSchema(e);return t.caption=new U.h(e.caption),t.description=new U.h(e.description),t.actions=this._mapActions(e.actions),t.inputParameters=this._mapParameters(e.inputParameters),t.outputParameters=this._mapParameters(e.outputParameters),t.subIntents=this._mapSubIntents(e.subIntents),t}convertToSchema(e){return this.createSchema(e)}mapModelToSchema(e,t){return e.prompt=t.Prompt,e.intentDescription=t.Description,e.caption.setValueLocalizableString(this._sysCultureName,t.Title),e.name=t.Code,e.status=t.Status,e.mode=t.Mode,e.type=t.Type,e.llmModel=t.LlmModel,e.restrictions=t.Restrictions,e.roleDescription=t.RoleDescription,e.responseFormatJsonSchema=t.ResponseFormatJsonSchema,this._convertDtoParametersToSchema(e,"inputParameters",t.InputParameters??[]),this._convertDtoParametersToSchema(e,"outputParameters",t.OutputParameters??[]),this._convertDtoActionToSchema(e,t.Actions),this._convertDtoSubIntentsToSchema(e,t.SubIntents??[]),e}schemaToModel(e,t){return{UId:e,Title:this._resourceFinderService.findLocalizableValue(t.caption),Code:t.name,Description:t.intentDescription||this._resourceFinderService.findLocalizableValue(t.description),Prompt:t.prompt,Status:t.status,Type:t.type,Actions:this._convertSchemaActionToDto(e,t),ExtendParent:t.extendParent,PackageUId:t.package?.uId,Mode:t.mode,LlmModel:t.llmModel,InputParameters:this._convertSchemaParametersToDto(e,t.inputParameters??[],"InputParameters"),OutputParameters:this._convertSchemaParametersToDto(e,t.outputParameters??[],"OutputParameters"),RoleDescription:t.roleDescription,Restrictions:t.restrictions,SubIntents:this._convertSchemaSubIntentsToDto(t),ResponseFormatJsonSchema:t.responseFormatJsonSchema}}static{this.\u0275fac=function(t){return new(t||ne)(d.\u0275\u0275inject(N.oq),d.\u0275\u0275inject(w.Q))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:ne,factory:ne.\u0275fac})}}function Es(c,e,t){return c.post(e,t,{headers:new T.HttpHeaders({"Content-Type":"application/json"})})}class ie extends fe{constructor(e){super(e)}createSubIntent(e,t){const s=this.serviceEndpoint+"CreateSubIntent",n={parentIntentUId:e,subIntentUId:t};return Es(this.httpClient,s,n)}deleteSubIntent(e,t){const s=this.serviceEndpoint+"DeleteSubIntent",n={parentIntentUId:e,subIntentUId:t};return Es(this.httpClient,s,n)}static{this.\u0275fac=function(t){return new(t||ie)(d.\u0275\u0275inject(d.Injector))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:ie,factory:ie.\u0275fac})}}class Me extends vn.${constructor(){super(),this._apiService=(0,d.inject)(ie),this._convertor=(0,d.inject)(ne),this._currentPackageService=(0,d.inject)(ye),this._serverClientOperationNotificationReceiver=(0,d.inject)(yn.k),this._queryExecutor=(0,d.inject)(In.w),this._copilotIntentChangedSubscribe()}_copilotIntentChangedSubscribe(){this._serverClientOperationNotificationReceiver.getNotifications("CopilotIntentChanged").subscribe(e=>this.setToCache(e.intentUId,this._getIntentSchema(e.intentUId)))}_normalizeUId(e){return e.toLocaleLowerCase()}_getIntentSchema(e){return this._apiService.getSchema({schemaUId:e,useFullHierarchy:!0}).pipe((0,a.map)(t=>{if(!t.success)throw new Error(t.errorInfo?.message||`Failed to get schema with UId: ${e}`);return t.schema}),(0,a.shareReplay)({bufferSize:1,refCount:!1}),(0,a.catchError)(t=>(0,a.throwError)(()=>t)))}setToCache(e,t){super.setToCache(this._normalizeUId(e),t)}getFromCache(e){return super.getFromCache(this._normalizeUId(e))}deleteFromCache(e){return super.deleteFromCache(this._normalizeUId(e))}get(e){let t=this.getFromCache(e);return t||(t=this._getIntentSchema(e),this.setToCache(e,t)),t.pipe((0,a.map)(s=>this._convertor.schemaToModel(e,s)))}getAllCodes(e){const t=new Sn.s(e);return t.addSchemaColumn("Code"),this._queryExecutor.executeSelectQuery(t).pipe((0,a.map)(s=>s.map(n=>String(n.Code))))}update(e){return this.getFromCache(e.UId).pipe((0,a.map)(t=>this._convertor.mapModelToSchema(t,e)),(0,a.switchMap)(t=>this._apiService.saveSchema(t)),(0,a.tap)(t=>{t.success||this.deleteFromCache(e.UId)}))}create(e){return this._currentPackageService.getDesignPackageUId(null).pipe((0,a.switchMap)(t=>this._apiService.createSchema({packageUId:t.uId,extendParent:!1,schemaUId:e})),(0,a.map)(t=>t.schema),(0,a.tap)(t=>this.setToCache(e,(0,a.of)(t))),(0,a.map)(t=>this._convertor.schemaToModel(e,t)))}createSubIntent(e,t){return this._apiService.createSubIntent(e,t).pipe((0,a.map)(s=>{if(!s.success)throw new Error(s.errorInfo?.message||`Failed to create SubIntent for IntentUId: ${e}`);return s}),(0,a.catchError)(s=>(0,a.throwError)(()=>s)))}deleteSubIntent(e,t){return this._apiService.deleteSubIntent(e,t).pipe((0,a.map)(s=>{if(!s.success)throw new Error(s.errorInfo?.message||`Failed to delete SubIntent for IntentUId: ${e}`);return s}),(0,a.catchError)(s=>(0,a.throwError)(()=>s)))}static{this.\u0275fac=function(t){return new(t||Me)}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:Me,factory:Me.\u0275fac})}}let Ae=class ps{static{this.\u0275fac=function(t){return new(t||ps)}}static{this.\u0275mod=d.\u0275\u0275defineNgModule({type:ps})}static{this.\u0275inj=d.\u0275\u0275defineInjector({providers:[{provide:fn.p,useClass:Me},{provide:ie,useFactory:e=>{const t=d.Injector.create({name:"CopilotIntentSchemaDesignerApiInjector",parent:e,providers:[un("CopilotIntentSchemaDesignerService.svc"),{provide:Cs,useClass:ne,deps:[N.oq]},{provide:gs,useValue:!0}]});return new ie(t)},deps:[d.Injector]},ne],imports:[b.CommonModule,he]})}};Ae=(0,r.__decorate)([(0,R.g)({})],Ae),function(){(typeof ngJitMode>"u"||ngJitMode)&&d.\u0275\u0275setNgModuleScope(Ae,{imports:[b.CommonModule,he]})}();var bn=l(95442),Ps=l(41833),Tn=l(86897),Rn=l(15505),J=l(10661);class ue{static{this.\u0275fac=function(t){return new(t||ue)}}static{this.\u0275mod=d.\u0275\u0275defineNgModule({type:ue})}static{this.\u0275inj=d.\u0275\u0275defineInjector({providers:[Tn.W,Rn.D,J.R],imports:[b.CommonModule,S.TranslateModule]})}}(function(){(typeof ngJitMode>"u"||ngJitMode)&&d.\u0275\u0275setNgModuleScope(ue,{imports:[b.CommonModule,S.TranslateModule]})})();var h=l(73308),xs=l(66459),bs=l(18872),Ts=l(71001),Dn=l(25853),Nn=l(40203),Ln=l(17679),wn=l(32709),$n=l(59888),tt;(function(c){c[c.None=0]="None",c[c.Module=1]="Module",c[c.EditViewModelSchema=2]="EditViewModelSchema",c[c.ModuleViewModelSchema=3]="ModuleViewModelSchema",c[c.DetailViewModelSchema=4]="DetailViewModelSchema",c[c.GridDetailViewModelSchema=5]="GridDetailViewModelSchema",c[c.EditControlsDetailViewModelSchema=6]="EditControlsDetailViewModelSchema",c[c.UnitTestModule=7]="UnitTestModule",c[c.GridEditDetailViewModelSchema=8]="GridEditDetailViewModelSchema",c[c.AngularSchema=9]="AngularSchema",c[c.MobileSchema=10]="MobileSchema"})(tt||(tt={}));class Ee{constructor(){this._appInfoService=(0,d.inject)($n.my),this._window=(0,d.inject)(y.ZP),this._lastSchemaVersion=null}_getLastSchemaVersion(){var e=this;return(0,h.A)(function*(){if(e._lastSchemaVersion!==null)return e._lastSchemaVersion;const t=yield(0,a.firstValueFrom)(e._appInfoService.loadSysValues());return e._lastSchemaVersion=t.freedomUiSchemaVersion,e._lastSchemaVersion})()}register(e,t,s){var n=this;return(0,h.A)(function*(){const i={schemaName:e,schemaUId:t,schemaCaption:null,parentSchemaName:null,packageName:null,extendParent:!1,parentSchemaUId:null,schemaVersion:yield n._getLastSchemaVersion(),dataSchemaDeps:[],type:tt.AngularSchema},o={localizableImages:{},localizableStrings:{},parametersLocalizableStrings:{}};n._window.define(e,[],()=>s),n._window.define(e+"Structure",[],()=>i),n._window.define(e+"Resources",[],()=>o)})()}static{this.\u0275fac=function(t){return new(t||Ee)}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:Ee,factory:Ee.\u0275fac,providedIn:"root"})}}var Rs=l(51521),Fn=l(81207);const Un=["schemaContainer"];function Vn(c,e){if(c&1&&(d.\u0275\u0275elementStart(0,"div",8)(1,"mat-error"),d.\u0275\u0275text(2),d.\u0275\u0275elementEnd()()),c&2){const t=d.\u0275\u0275nextContext();d.\u0275\u0275advance(2),d.\u0275\u0275textInterpolate1(" ",t.schemaError," ")}}class Pe extends Ts.P{constructor(){super(...arguments),this._schemaRegisterService=(0,d.inject)(Ee),this._schemaComponentType=(0,d.inject)(Ln.O),this._injectionContextService=(0,d.inject)(wn.K),this._injector=(0,d.inject)(d.Injector)}_getConverter(e){var t=this;return(0,h.A)(function*(){const s=e+"ToSchema",i=bs.c.has(s)?s:"crt.BaseLlmViewElementConfigToSchema",o=bs.c.get(i);o.lazy&&(yield o.lazyModuleRef.loadAndBootstrap());const p=i,u=t._injectionContextService.createContext(p,t._injector);return o.instantiate(u)})()}_renderSchema(e){const t=this.schemaContainerRef.createComponent(this._schemaComponentType);this._schemaComponent=t.instance,this._schemaComponent.schemaExceptionThrown?.pipe((0,g.take)(1)).subscribe(s=>{this.schemaError=s?.message,t.changeDetectorRef.markForCheck()}),this.schemaContainerRef.insert(t.hostView),this._schemaComponent.features={profile:!1,mask:{canShow:!1}},this._schemaComponent.schemaName=e}_onMessageChanged(){var e=this;return(0,h.A)(function*(){const t=yield e._getConverter(e.message.view.element.type),s=yield t.convert(e.message.view.element,null,e.message.id),n=t.getSchemaName(e.message.id);yield e._schemaRegisterService.register(n,e.message.id,s),e._renderSchema(n)})()}ngOnChanges(e){super.ngOnChanges(e),e.message?.currentValue&&this._onMessageChanged()}static{this.\u0275fac=(()=>{let e;return function(s){return(e||(e=d.\u0275\u0275getInheritedFactory(Pe)))(s||Pe)}})()}static{this.\u0275cmp=d.\u0275\u0275defineComponent({type:Pe,selectors:[["crt-view-element-chat-message"]],viewQuery:function(t,s){if(t&1&&d.\u0275\u0275viewQuery(Un,7,d.ViewContainerRef),t&2){let n;d.\u0275\u0275queryRefresh(n=d.\u0275\u0275loadQuery())&&(s.schemaContainerRef=n.first)}},inputs:{message:"message"},standalone:!0,features:[d.\u0275\u0275InheritDefinitionFeature,d.\u0275\u0275NgOnChangesFeature,d.\u0275\u0275StandaloneFeature],decls:12,vars:8,consts:[["schemaContainer",""],[3,"message"],["crtLinkNavigation","","crtFullSizeImage",""],[1,"text-content"],[1,"schema-wrapper"],["class","schema-error","role","alert",4,"ngIf"],["toggleType","material",1,"setup-details-expansion-panel",3,"title","expanded"],[1,"setup-details-text"],["role","alert",1,"schema-error"]],template:function(t,s){t&1&&(d.\u0275\u0275elementStart(0,"crt-chat-base-message",1)(1,"div",2)(2,"markdown",3),d.\u0275\u0275text(3),d.\u0275\u0275elementEnd(),d.\u0275\u0275elementStart(4,"div",4),d.\u0275\u0275elementContainer(5,null,0),d.\u0275\u0275elementEnd(),d.\u0275\u0275template(7,Vn,3,1,"div",5),d.\u0275\u0275elementStart(8,"crt-expansion-panel",6),d.\u0275\u0275pipe(9,"translate"),d.\u0275\u0275elementStart(10,"markdown",7),d.\u0275\u0275text(11),d.\u0275\u0275elementEnd()()()()),t&2&&(d.\u0275\u0275property("message",s.message),d.\u0275\u0275advance(3),d.\u0275\u0275textInterpolate(s.message==null?null:s.message.view.description),d.\u0275\u0275advance(4),d.\u0275\u0275property("ngIf",s.schemaError),d.\u0275\u0275advance(),d.\u0275\u0275property("title",d.\u0275\u0275pipeBind1(9,6,"Copilot.ViewElementMessage.SetupDetailsCaption"))("expanded",!1),d.\u0275\u0275advance(3),d.\u0275\u0275textInterpolate(s.message==null?null:s.message.view.details))},dependencies:[b.CommonModule,b.NgIf,Rs.MarkdownModule,Rs.MarkdownComponent,Dn.A,Ts.P,Nn.D,Fn.o,S.TranslateModule,S.TranslatePipe,xs.MatFormFieldModule,xs.MatError],styles:[".schema-wrapper[_ngcontent-%COMP%]{margin:12px 16px 0}.schema-error[_ngcontent-%COMP%], .setup-details-expansion-panel[_ngcontent-%COMP%]{margin:0 16px}.setup-details-text[_ngcontent-%COMP%]{margin:-16px 0}"],changeDetection:0})}}const Ds="CopilotChatInitMessagesSubscriptions",Ns="NavigationStateIsLoading",st="CurrentPageSchemaName",Ls="CopilotIntents",ws="CopilotIntentPageQuickLinks",On="CopilotQuickActions",nt="viewElement";var ke=l(22701),pe=l(48594),Hn=l(84323),B;(function(c){c.Assistant="assistant",c.User="user",c.System="system",c.Tool="tool"})(B||(B={}));var xe;(function(c){c.Text="text",c.ViewElement="view-element",c.Confirmation="confirmation"})(xe||(xe={}));class me{static get photo(){return"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTAsMTdhNSw1LDAsMCwwLDQuMS0yLjE0VjE2YS45LjksMCwwLDAsMS44LDBWOGEuOS45LDAsMCwwLTEuOCwwVjkuMTRBNSw1LDAsMSwwLDEwLDE3Wm0wLTEuOEEzLjIsMy4yLDAsMSwwLDYuOCwxMiwzLjIsMy4yLDAsMCwwLDEwLDE1LjJaIiBmaWxsPSIjMGQyZTRlIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiLz48cGF0aCBkPSJNMTguOSw4YS45LjksMCwwLDAtMS44LDB2OGEuOS45LDAsMCwwLDEuOCwwWiIgZmlsbD0iIzBkMmU0ZSIvPjwvc3ZnPg"}static get title(){return"Creatio.ai"}static get contact(){return{photo:this.photo,name:this.title}}}class Q{constructor(e){this._userInfo=e,this._fileMessageRegex=/#FileId\s+(\S+);.*?#FileName\s+([^;]+);/}_getAuthorByRole(e){return e.role!==B.Assistant&&e.role!==B.Tool?null:e.rootIntentCaption?{id:e.rootIntentId,name:e.rootIntentCaption}:me.contact}_getIsTextWithButtonsMessage(e){return e.contentType===xe.Confirmation}_getIsBotMessage(e){return e===B.Assistant}_getMessageDirection(e){return e===B.User?pe.Tt.Outcoming:pe.Tt.Incoming}_getIsFileMessage(e){return e.role===B.System&&this._fileMessageRegex.test(e.content)}_getUtcDate(e){const t=new Date(e);return new Date(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds())}_getTextWithButtonsMessage(e,t){const s=Array.isArray(e.buttons)&&e.buttons.length>0;if(!!e.confirmationResult||!s)return this._getMessage(e,t);const i=this._getMessage(e,t);return{...i,type:ke.X.TextWithButtons,text:i.text,buttons:e.buttons,confirmationResult:null}}_getMessage(e,t){const n=e.createdOnTicks-621355968e9,i=Number(n/1e4),o=this._getUtcDate(i);return(0,Hn.v8)(o,this._userInfo.timeZoneOffsetHours),{text:e.content,type:ke.X.Text,date:o,id:e.id,author:this._getAuthorByRole(e),isBotMessage:this._getIsBotMessage(e.role),direction:this._getMessageDirection(e.role)}}_getFileMessage(e,t){const[,s,n]=e.content.match(this._fileMessageRegex);return{...this._getMessage(e,t),type:ke.X.File,direction:pe.Tt.Outcoming,text:"",attachments:[{fileId:s,fileName:n,fileType:pe.Go.File,fileEntitySchemaName:"CreatioAISessionFile"}]}}_getIsSupportedMessage(e){return!(0,F.isEmpty)(e.content)&&(e.role===B.Assistant||e.role===B.User||e.forwardToClient||e.isFileMessage||e.isTextWithButtonsMessage)}_isViewElementMessage(e){return e.contentType===xe.ViewElement?!0:e.content?.includes("##viewElement##")}_getViewElementMessage(e,t){let s;return e.contentType===xe.ViewElement&&(s=JSON.parse(e.content)),{...this._getMessage(e,t),author:this._getAuthorByRole(e),isBotMessage:!0,type:nt,view:s}}_extendCopilotMessage(e){return{...e,isFileMessage:this._getIsFileMessage(e),isViewElementMessage:this._isViewElementMessage(e),isTextWithButtonsMessage:this._getIsTextWithButtonsMessage(e)}}convertMessages(e,t){return e.map(s=>this._extendCopilotMessage(s)).filter(this._getIsSupportedMessage).map(s=>s.isViewElementMessage?this._getViewElementMessage(s,t):s.isFileMessage?this._getFileMessage(s,t):s.isTextWithButtonsMessage?this._getTextWithButtonsMessage(s,t):this._getMessage(s,t))}static{this.\u0275fac=function(t){return new(t||Q)(d.\u0275\u0275inject(N.oq))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:Q,factory:Q.\u0275fac})}}var Be=l(4164);let it=class{constructor(e){this._intentSchemaManager=e}convert(e,t,s){var n=this;return(0,h.A)(function*(){const i=e.map(function(){var p=(0,h.A)(function*(u){return yield u[s]});return function(u){return p.apply(this,arguments)}}()),o=yield Promise.all(i);return(0,a.lastValueFrom)(n._intentSchemaManager.generateActionCode(o))})()}};it=(0,r.__decorate)([(0,Be.a)({type:"crt.GenerateCopilotActionCode"}),(0,r.__metadata)("design:paramtypes",[J.R])],it);let at=class{constructor(e){this._intentSchemaManager=e}convert(e,t,s){var n=this;return(0,h.A)(function*(){const i=e.map(function(){var p=(0,h.A)(function*(u){return yield u[s]});return function(u){return p.apply(this,arguments)}}()),o=yield Promise.all(i);return(0,a.lastValueFrom)(n._intentSchemaManager.generateSkillCode(o))})()}};at=(0,r.__decorate)([(0,Be.a)({type:"crt.GenerateCopilotSkillCode"}),(0,r.__metadata)("design:paramtypes",[J.R])],at);let ot=class{convert(e,t,s){const[n,i]=e;return n||(s?!i:i)}};ot=(0,r.__decorate)([(0,Be.a)({type:"crt.CopilotChatMode"})],ot);let rt=class{convert(e){return e?.map(s=>s).sort((s,n)=>{const i=typeof s.date=="string"?new Date(s.date):s.date,o=typeof n.date=="string"?new Date(n.date):n.date;return!i||!o?0:o.getTime()-i.getTime()})}};rt=(0,r.__decorate)([(0,Be.a)({type:"crt.CopilotChatListConverter"})],rt);var X=l(81517),z=l(2828),f=l(41287),C=l(844);let $s=class extends X.S{};$s=(0,r.__decorate)([(0,z.$)({type:"crt.CodeChangeParameterListRequest",scopes:["AISkills_FormPage"]})],$s);let ct=class extends f.l{constructor(){super(...arguments),this._windowCodeList="_copilotCodeList"}_extractKeys(e,t){return(0,h.A)(function*(){if(!e||e.length===0)return[];const s=e.map(function(){var n=(0,h.A)(function*(i){return yield i?.[t]});return function(i){return n.apply(this,arguments)}}());return Promise.all(s)})()}handle(e){var t=this;return(0,h.A)(function*(){const s=e.$context,n=yield s?.InputParametersDetail,i=yield s?.OutputParametersDetail,o=[...yield t._extractKeys(n,"InputParametersDS_Code"),...yield t._extractKeys(i,"OutputParametersDS_Code")];if(o.length===0){yield t.next?.handle(e);return}window[t._windowCodeList]=o,yield t.next?.handle(e)})()}};ct=(0,r.__decorate)([(0,C.l)({type:"crt.CodeChangeParameterListHandler",requestType:"crt.CodeChangeParameterListRequest",scopes:["AISkills_FormPage"]})],ct);var jn=l(60575);class G{constructor(e){this._googleTagManager=e}_isCreatioPageContextPart(e){return e&&typeof e=="object"&&"pageSchemaName"in e&&typeof e.pageSchemaName=="string"}_getPageContextGTM(){var e=this;return(0,h.A)(function*(){try{return(yield I.d.instance.getContext()).filter(e._isCreatioPageContextPart).map(n=>n.pageSchemaName).join(", ")||null}catch(t){return console.error("Error processing copilot context:",t),null}})()}sendGTMData(e){var t=this;return(0,h.A)(function*(){const s=yield t._getPageContextGTM(),n=Object.assign(e,{moduleName:"Creatio.AI",schemaName:"CopilotPanel",eventName:"CreatioAI_Engagement",source:s||""});t._googleTagManager.track(n)})()}static{this.\u0275fac=function(t){return new(t||G)(d.\u0275\u0275inject(jn.A))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:G,factory:G.\u0275fac,providedIn:"root"})}}var Fs=l(18357),Us=l(97398),Vs=l(13161);class be{constructor(e){this._window=e}postMessage(e){this._window.parent.postMessage(e,"*")}message$(){return(0,a.fromEvent)(this._window,"message").pipe((0,a.filter)(e=>e.data&&typeof e.data.type=="string"&&"payload"in e.data))}static{this.\u0275fac=function(t){return new(t||be)(d.\u0275\u0275inject(y.ZP))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:be,factory:be.\u0275fac,providedIn:"root"})}}var Te=l(20555);const kn="embedded";function Bn(){return window.parent===window?!1:new URLSearchParams(window.location.search).has(kn)}class Os{static{this._errorCodeGroups={AuthorizationError:["MissingApiKey","InvalidApiKey","Unauthorized","UnauthorizedClient","InvalidScope","InvalidGrantType"],FormatError:["InvalidRequest","InvalidJson","NoEntities"],LimitError:["RateLimitReached","InsufficientQuota","QuotaExceeded","InternalQuotaExceeded","LimitExceeded"],ActionLimitError:["ActionsRateLimitReached","ActionsInsufficientQuota","ActionsQuotaExceeded","ActionsInternalQuotaExceeded","ActionsLimitExceeded"],ServiceAvailabilityError:["ServiceUnavailable","ServerNotAvailable","EngineOverloaded","ServerError","RequestTimeout","NetworkError"],ExecutionError:["ActionExecutionFailed","InvalidResponse"],ConfigurationError:["InvalidUri","ModelNotFound","ModelError","IncorrectConfiguration"],UnknownError:["Unknown","UnknownError"]}}static{this.singleErrors=["CharacterLimitExceededError","ToolCallsInvokesLimitExceeded","InsufficientPermissions"]}static{this.errorCodeToGroup=this._populateErrorCodeToGroupMap()}static _populateErrorCodeToGroupMap(){const e={};return Object.keys(this._errorCodeGroups).forEach(t=>{for(const s of this._errorCodeGroups[t])e[s]=t}),e}static getErrorMessageKey(e){return this.singleErrors.includes(e)?`MessageEditor.ErrorCode.${e}`:`MessageEditor.ErrorCode.${this.errorCodeToGroup[e]||"UnknownError"}`}}var k;(function(c){c.WaitingForUserMessage="WaitingForUserMessage",c.UserMessageQueued="UserMessageQueued",c.ExecutingAction="ExecutingAction",c.WaitingForAssistantMessage="WaitingForAssistantMessage",c.TitleUpdated="TitleUpdated"})(k||(k={}));var zn=l(72572),Gn=l(92385);const Hs="CopilotMsgChannelSender",Wn="CopilotChatPart",Kn="CopilotSessionProgress";class V{constructor(e,t,s,n,i,o,p,u,m){this._userInfo=e,this._httpClient=t,this._translateService=s,this._messageChannelService=n,this.liveEditingService=i,this._featureValues=o,this._liveAnnouncementService=p,this._copilotContentUtils=u,this._copilotGtmService=m,this._apiUrl="/rest/CopilotService",this._copilotSession=null,this._copilotSessionProgress$=new a.Subject,this._defaultPageSize=15;const _=this._featureValues??{};this._isNeedToAddConsoleLog=!!_.ShowSystemMessagesFromCopilot}_copilotSessionProgressEvent$(){return this._messageChannelService.messageEvent$.pipe((0,a.filter)(e=>e.header.sender===Hs&&e.header.bodyTypeName===Kn),(0,a.map)(e=>e.body))}_logCopilot(e){this._isNeedToAddConsoleLog&&(console.group("Copilot"),console.log(e),console.groupEnd())}_loadInitialMessages(){return this._getActiveCopilotSessions().pipe((0,a.mergeMap)(e=>this._handleActiveCopilotSessions(e).pipe((0,a.catchError)(t=>(console.log(t),(0,a.of)([]))))))}_handleActiveCopilotSessions(e){return e.length>0?(this._copilotSession=e[0],this.getCopilotSessionMessages(this._copilotSession.id)):(0,a.throwError)(()=>new Error("No active copilot sessions found"))}_getActiveCopilotSessions(){return this._httpClient.post(`${this._apiUrl}/GetActiveCopilotSessions`,{}).pipe((0,a.map)(e=>e.copilotSessions))}_notifyCopilotSessionProgress(e){this._copilotSessionProgress$.next({copilotSessionId:this._copilotSession?.id,state:e})}_sendUserMessage(e,t=void 0,s={rootIntentIds:[]}){const n=performance.now();return(0,a.of)(k.UserMessageQueued).pipe((0,a.tap)(i=>this._notifyCopilotSessionProgress(i)),(0,a.switchMap)(()=>I.d.instance.getContext()),(0,a.switchMap)(i=>this._httpClient.post(`${this._apiUrl}/SendMessage`,{content:e,copilotContext:JSON.stringify(i||[]),copilotSessionId:t,options:s})),(0,a.map)(i=>i?.copilotChatPart),(0,a.tap)(()=>{const i=performance.now(),o={action:"response_received",responseTime:Math.floor(i-n),primaryColumnValue:t};this._copilotGtmService.sendGTMData(o)}),(0,a.catchError)(i=>(0,a.of)({errorCode:"unknown",errorMessage:`${i}`,copilotSession:this._copilotSession,messages:[]})),(0,a.tap)(i=>{(0,F.isEmpty)(i?.errorMessage)||this._notifyCopilotSessionProgress(k.WaitingForUserMessage)}))}_getMentionAgents(e){const t=document.createElement("div");return t.innerHTML=e,Array.from(t.querySelectorAll(".mention")).map(s=>s.getAttribute("data-mention")).filter(s=>!!s)}_closeCopilotSession(){return this._httpClient.post(`${this._apiUrl}/CloseSession`,{copilotSessionId:this._copilotSession?.id}).pipe((0,a.catchError)(e=>(0,a.throwError)(()=>new Error(`Server return status: ${e.status}`))))}_getCachedRowCount(e){try{const t=window.sessionStorage.getItem(`${e}_rows`);return t?parseInt(t,10):void 0}catch{return}}_setCachedRowCount(e,t){try{window.sessionStorage.setItem(`${e}_rows`,t.toString())}catch{}}mapSessions(e){return(!e.author?.id||e.author.id===x.To)&&(e.author=me.contact),e.caption=e.caption||this._translateService.instant("Copilot.NewChatCaption"),e}getInitialMessages$(){return this._loadInitialMessages()}copilotSessionEvent$(e){return(0,a.merge)(this.copilotMessageEvent$().pipe((0,a.map)(t=>({lastMessage:e.convertMessages(t.messages,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})?.slice().sort((i,o)=>o.date.getTime()-i.date.getTime())?.[0],sessionId:t.copilotSession?.id})),(0,a.filter)(t=>!!t.lastMessage),(0,a.map)(t=>({id:t.sessionId,date:t.lastMessage.date,preview:this._copilotContentUtils.getPreview(t.sessionId,t.lastMessage.text,t.lastMessage.isBotMessage),previewFromServer:this._copilotContentUtils.toPlainText(t.lastMessage.text),author:t.lastMessage.author}))),this.copilotSessionProgressEvent$().pipe((0,a.filter)(t=>t.state===k.TitleUpdated),(0,a.map)(t=>({id:t.copilotSessionId,caption:t.copilotSessionTitle}))))}copilotMessageEvent$(){return this._messageChannelService.messageEvent$.pipe((0,a.filter)(e=>e.header.sender===Hs&&e.header.bodyTypeName===Wn),(0,a.map)(e=>e.body),(0,a.tap)(e=>this._logCopilot(e)))}copilotSessionProgressEvent$(){return(0,a.merge)(this._copilotSessionProgressEvent$(),this._copilotSessionProgress$.asObservable()).pipe((0,a.tap)(e=>this._logCopilot(e)))}sessionUpdateEvent$(){return this.liveEditingService.liveEditingEvent$.pipe((0,a.filter)(e=>e.entitySchemaName==="CopilotSessionEnt"))}sayWithResponse(e){return this.sayToSessionWithResponse(e,this._copilotSession?.id)}sayToSessionWithResponse(e,t){var s=this;return(0,h.A)(function*(){const i={rootIntentIds:s._getMentionAgents(e)},o=s._copilotContentUtils.sanitizeContent(e),p=yield(0,a.firstValueFrom)(s._sendUserMessage(o,t,i));return p&&(0,F.isEmpty)(p.errorCode)&&(0,F.isEmpty)(p.errorMessage)&&(s._copilotSession=p.copilotSession,s._liveAnnouncementService.announce("Copilot.MessageSent")),p})()}closeSession(){var e=this;return(0,h.A)(function*(){if(!e._copilotSession?.id)return Promise.reject(new Error("No active session"));try{yield(0,a.firstValueFrom)(e._closeCopilotSession()),e._copilotSession=null}catch(t){return Promise.reject(new Error(`Server return status: ${t.status}`))}})()}renameSession(e,t){return this._httpClient.post(`${this._apiUrl}/RenameSession`,{copilotSessionId:e,sessionName:t}).pipe((0,a.map)(s=>s.RenameSessionResult))}getActiveSessionPreviewById(e){return this._httpClient.get(`${this._apiUrl}/GetActiveSessionPreviewById/${e}`).pipe((0,a.filter)(t=>!!t),(0,a.map)(t=>({...t,author:{id:t.author.id,name:t.author?.caption||t.author?.name},preview:this._copilotContentUtils.getPreview(t.id,t.preview,t.author?.id!==this._userInfo.contactId),previewFromServer:this._copilotContentUtils.toPlainText(t.preview)})))}getActiveSessionsWithPreview(e=0,t=15,s=""){return this._httpClient.post(`${this._apiUrl}/SearchSessionsPageWithPreview`,{count:t,offset:e,search:s}).pipe((0,a.map)(n=>n.map(i=>({...i,author:{id:i.author?.id,name:i.author?.caption||i.author?.name},preview:this._copilotContentUtils.getPreview(i.id,i.preview,this._userInfo.contactId!==i.author?.id),previewFromServer:this._copilotContentUtils.toPlainText(i.preview)}))))}getCopilotSessionMessages(e){return this._httpClient.post(`${this._apiUrl}/GetCopilotSessionMessage`,{copilotSessionId:e}).pipe((0,a.map)(t=>t.copilotMessages))}getCopilotSessionMessagesPagination(e,t=0,s=15,n=!1){s=s||this._defaultPageSize,t=t||0;const i=this._getCachedRowCount(e);return n?i!==void 0&&(s=Math.max(i,this._defaultPageSize)):this._setCachedRowCount(e,s),this._httpClient.get(`${this._apiUrl}/getCopilotSessionMessages/?sessionId=${e}&offset=${t}&rowCount=${s}`).pipe((0,a.map)(o=>(this._setCachedRowCount(e,t+o?.copilotMessages?.length),o.copilotMessages)))}getCopilotSearchMessagesBatch(e,t){return this._httpClient.post(`${this._apiUrl}/GetCopilotSearchMessagesBatch`,{copilotSessionId:e,searchMessageId:t}).pipe((0,a.map)(s=>(this._setCachedRowCount(e,s?.copilotMessages?.length),s.copilotMessages)))}static{this.\u0275fac=function(t){return new(t||V)(d.\u0275\u0275inject(N.oq),d.\u0275\u0275inject(T.HttpClient),d.\u0275\u0275inject(S.TranslateService),d.\u0275\u0275inject(W.A),d.\u0275\u0275inject(zn.m),d.\u0275\u0275inject(De.G,8),d.\u0275\u0275inject(y.DW),d.\u0275\u0275inject(Gn.$),d.\u0275\u0275inject(G))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:V,factory:V.\u0275fac,providedIn:"root"})}}var lt=l(6503);class te{constructor(e,t,s,n){this._copilotChatService=e,this._notifyService=t,this._translateService=s,this._copilotGtmService=n}_getCurrentUserTime(){return new Date().getTime()*1e4+621355968e9}_sendErrorMessageToChat(e,t){if(!e)return;const s=Os.getErrorMessageKey(t??""),n={id:(0,x.qv)(),createdOnTicks:this._getCurrentUserTime(),content:this._translateService.instant(s),role:B.Assistant,isSaved:!0};e?.messages?.push(n)}_notifyUser(e){var t=this;return(0,h.A)(function*(){const s=Os.getErrorMessageKey(e??"");yield t._notifyService.error({message:s})})()}getInitialMessages$(){return this._copilotChatService.getInitialMessages$()}copilotMessageEvent$(){return this._copilotChatService.copilotMessageEvent$()}copilotSessionProgressEvent$(){return this._copilotChatService.copilotSessionProgressEvent$()}closeSession(){return this._copilotChatService.closeSession()}sayWithResponse(e){var t=this;return(0,h.A)(function*(){let s;try{s=yield t._copilotChatService.sayWithResponse(e);const n=s?.errorCode;return n&&(t._sendErrorMessageToChat(s,n),yield t._notifyUser(n)),s}catch(n){yield t._notifyUser(),console.error(n)}})()}sayToSessionWithResponse(e,t){var s=this;return(0,h.A)(function*(){let n;try{n=yield s._copilotChatService.sayToSessionWithResponse(e,t);const i=n?.errorCode;return i&&(s._sendErrorMessageToChat(n,i),yield s._notifyUser(i),yield s._copilotGtmService.sendGTMData({action:"error_received",description:i})),n}catch(i){yield s._notifyUser(),console.error(i)}})()}static{this.\u0275fac=function(t){return new(t||te)(d.\u0275\u0275inject(V),d.\u0275\u0275inject(lt.F),d.\u0275\u0275inject(S.TranslateService),d.\u0275\u0275inject(G))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:te,factory:te.\u0275fac,providedIn:"root"})}}class Jn extends f.l{constructor(e){super(),this._sidebarStateService=e.get(Us.p),this._copilotChatService=e.get(te),this._profileService=e.get(Fs.c),this._customEventService=e.get(y.Dj),this._iframeMessengerService=e.get(be)}_getChatPanelProfileData(){var e=this;return(0,h.A)(function*(){return yield(0,a.firstValueFrom)(e._profileService.getProfile(Vs.j))})()}_getChatSessionId(){var e=this;return(0,h.A)(function*(){const t=yield e._getChatPanelProfileData(),s=yield(0,a.firstValueFrom)(e._sidebarStateService.opened.rootSidebar$);return t&&!t.isChatsListVisible&&s===Te.bd?t.lastChatId:null})()}handle(e){var t=this;return(0,h.A)(function*(){const s=e;let n;if(s.useCurrentSession?(e.$context.CurrentCopilotSessionId=(yield e.$context.CurrentCopilotSessionId)??(0,x.qv)(),n=yield e.$context.CurrentCopilotSessionId):n=yield t._getChatSessionId(),yield t._sidebarStateService.openRootSidebar(Te.bd),!n)return n=(0,x.qv)(),t._customEventService.createOutboundChannel(Te.ll).next({sessionId:n,message:s.prompt}),Promise.resolve(null);const i=yield t._copilotChatService.sayToSessionWithResponse(s.prompt,n);return Bn()&&!i?.errorCode&&t._iframeMessengerService.postMessage({type:"copilot-prompt-sent",payload:{promptCode:s.promptCode}}),i})()}}let dt=class extends Jn{constructor(e){super(e),this._copilotGtmService=e.get(G)}_sendGTMData(e){var t=this;return(0,h.A)(function*(){const s={action:"skill_button_clicked",description:e.promptCode};yield t._copilotGtmService.sendGTMData(s)})()}handle(e){var t=()=>super.handle,s=this;return(0,h.A)(function*(){yield t().call(s,e),yield s._sendGTMData(e),yield s.next?.handle(e)})()}};dt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotActionRequestHandler",requestType:"crt.CopilotActionRequest"}),(0,r.__metadata)("design:paramtypes",[d.Injector])],dt);class Z{constructor(e){this._httpClient=e,this._executeIntentUrl="/rest/CopilotService/ExecuteIntent",this._getAvailableIntentsUrl="/rest/CopilotService/GetAvailableIntents",this._getAvailableAgentsUrl="/rest/CopilotService/GetAvailableAgents",this._agents$=null}_initializeAgents(){this._agents$=this._httpClient.get(this._getAvailableAgentsUrl).pipe((0,a.shareReplay)({bufferSize:1,refCount:!0}),(0,g.catchError)(e=>(0,a.throwError)(()=>new Error(`Server return status: ${e.status}`))))}_transformInputParameters(e){return e?Object.entries(e).map(([t,s])=>({Key:t,Value:s||""})):[]}_transformOutputParameters(e){return e?e.reduce((t,s)=>(t[s.Key]=s.Value,t),{}):null}_executeIntent(e,t,s){const n=this._transformInputParameters(s),i={intentName:e,additionalPromptText:t,parameters:n};return this._httpClient.post(this._executeIntentUrl,i).pipe((0,a.map)(o=>(o.isSuccess&&(o.resultParameters=this._transformOutputParameters(o.resultParameters)),o)),(0,g.catchError)(o=>(0,a.throwError)(()=>new Error(`Server return status: ${o.status}`))))}_getAvailableIntents(e,t){const s={names:e},n=this._getAvailableIntentsUrl+`/?mode=${t}`;return this._httpClient.post(n,s).pipe((0,g.catchError)(i=>(0,a.throwError)(()=>new Error(`Server return status: ${i.status}`))))}executeIntent(e,t,s){var n=this;return(0,h.A)(function*(){try{return yield(0,a.firstValueFrom)(n._executeIntent(e,t,s))}catch(i){const o=i.status?`Server return status: ${i.status}`:`${i}`;return Promise.reject(o)}})()}getAvailableIntents(e,t){var s=this;return(0,h.A)(function*(){t||(t="API");try{return yield(0,a.firstValueFrom)(s._getAvailableIntents(e,t))}catch(n){const i=n.status?`Server return status: ${n.status}`:`${n}`;return Promise.reject(i)}})()}getAvailableAgents(){var e=this;return(0,h.A)(function*(){if(e._agents$||e._initializeAgents(),!e._agents$)throw new Error("Agents could not be initialized");try{return yield(0,a.firstValueFrom)(e._agents$)}catch(t){const s=t.status?`Server return status: ${t.status}`:`${t}`;return Promise.reject(s)}})()}static{this.\u0275fac=function(t){return new(t||Z)(d.\u0275\u0275inject(T.HttpClient))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:Z,factory:Z.\u0275fac,providedIn:"root"})}}let ht=class extends f.l{constructor(e){super(),this._watchAttributes=[st,Ls,ws],this._runMode="Chat",this._copilotService=e.get(Z)}_actualizeCopilotQuickActions(e){var t=this;return(0,h.A)(function*(){const s=yield e[On],n=(yield e[Ls])??[],i=yield e[ws];if(!Array.isArray(n)||n.length===0||!Array.isArray(i)||i.length===0)return;yield s.clear();const o=yield e[st];let u=(yield Promise.all(i.map(function(){var _=(0,h.A)(function*(O){return{pageName:yield O.PageName,intentCode:yield O.IntentCode}});return function(O){return _.apply(this,arguments)}}()))).filter(_=>t._isPatternMatch(_.pageName,o)).map(_=>_.intentCode);u.length>0&&(u=(yield t._copilotService.getAvailableIntents(u,t._runMode))?.availableIntentNames??[]);const m=[];for(const _ of n){const O=yield _.Code;t._hasMatchingPattern(u,O)&&m.push(_)}yield s.reload(m)})()}_hasMatchingPattern(e,t){return e.some(s=>this._isPatternMatch(s,t))}_isPatternMatch(e,t){t=`${t}`.trim().toLowerCase(),e=`${e}`.trim().toLowerCase();const[s]=e.split("*").filter(Boolean);return e==="*"?!0:e.startsWith("*")?t.endsWith(s):e.endsWith("*")?t.startsWith(s):e===t}handle(e){var t=this;return(0,h.A)(function*(){const s=e.$context;if(t._watchAttributes.includes(e.attributeName))return yield t._actualizeCopilotQuickActions(s),t.next?.handle(e)})()}};ht=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotActualizeIntentQuickLinksHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],ht);var j=l(91775),js=l(40968);class Re{constructor(){this._pageChange$=new a.BehaviorSubject(void 0)}pageChangeEvent$(){return this._pageChange$.asObservable()}setPage(e){this._pageChange$.next(e)}static{this.\u0275fac=function(t){return new(t||Re)}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:Re,factory:Re.\u0275fac,providedIn:"root"})}}var Qn=l(97842),Xn=l(38641),ae=l(29957);let ut=class extends f.l{constructor(e,t,s,n,i,o,p,u){super(),this._copilotChatService=e,this._aiChatPageContextService=t,this._crtRouter=s,this._userInfo=n,this._injector=i,this._featureValues=o,this._liveAnnouncementService=p,this._translationService=u,this.userConsentService=i.get(v.F),this._copilotToChatConvertor=i.get(Q)}_openNewConversation(e,t){return(0,h.A)(function*(){const s={type:"crt.CopilotNewChatRequest",scopes:t.scopes,$context:e};yield j.t.instance.process(s)})()}_openConversation(e,t){return(0,h.A)(function*(){const s={type:"crt.ChatSessionOpenRequest",session:{id:(yield e.CurrentCopilotSessionId)??x.To},scopes:t.scopes,$context:e};yield j.t.instance.process(s)})()}_getConvertedMessages(e){return this._copilotToChatConvertor.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})}_initUserConsentData(e){this.userConsentService.getConsent("CopilotLegalNotice").subscribe(t=>{t&&(e.CopilotDisclaimer=t.consentText,this.userConsentService.getUserConsent(t.id).subscribe(s=>{e.IsCopilotChatVisible=s!==null,e.IsCopilotDisclaimerVisible=s===null}))})}_initWatchNavigation(e){var t=this;return(0,h.A)(function*(){const s=t._crtRouter.navigateStart$.pipe((0,a.tap)(()=>e[Ns]=!0)).subscribe(),n=t._crtRouter.navigateEnd$.pipe((0,a.tap)((0,h.A)(function*(){e[Ns]=!1;const i=yield(0,a.firstValueFrom)(t._crtRouter.crtRoute$);(i?.state?.moduleName||i?.state?.schemaName)&&t._aiChatPageContextService.setPage(i?.state?.schemaName)}))).subscribe();t._aiChatPageContextService.pageChangeEvent$().subscribe(i=>{e[st]=i}),yield t._addToSubscriptions(e,[s,n])})()}_onSessionProgressEvent(e,t){var s=this;return(0,h.A)(function*(){const n=e?.copilotSessionId;n&&(yield s._updateSessionTypingStatus(n,e,t))})()}_onMessageEvent(e,t){var s=this;(0,h.A)(function*(){try{if(e.copilotSession?.id===(yield t.$context.CurrentCopilotSessionId)){const n=Array.isArray(yield t.$context.ChatMessages)?yield t.$context.ChatMessages:[],i=new Set(n.map(u=>u.id)),o=s._getConvertedMessages(e.messages),p=o.filter(u=>!i.has(u.id));t.$context.ChatMessages=[...n,...p],yield s._announceMessagesInCurrentChat(o)}else yield s._announceMessagesInAnotherChat(e,t)}catch(n){console.error("Error processing messages:",n)}})()}_announceMessagesInAnotherChat(e,t){var s=this;return(0,h.A)(function*(){const n=s._translationService.instant("Copilot.LiveAnnouncement.MessageReceivedInAnotherChat"),i=((yield t.$context.ActiveChats)||[]).find(o=>o.id===e.copilotSession.id);if(i){yield new Promise(p=>setTimeout(p,0));const o=ae.String.format(n,e.messages[0].rootIntentCaption||me.title,i.caption);yield s._liveAnnouncementService.announce(o)}})()}_announceMessagesInCurrentChat(e){var t=this;return(0,h.A)(function*(){const s=t._translationService.instant("Copilot.LiveAnnouncement.MessageReceivedInCurrentChat");yield new Promise(n=>setTimeout(n,0));for(const n of e.filter(i=>i.direction===pe.Tt.Incoming)){const i=ae.String.format(s,n.author?.name,n.text);yield t._liveAnnouncementService.announce(i)}})()}_onActiveSessionEvent(e,t){var s=this;this._copilotChatService.getActiveSessionPreviewById(e.primaryColumnValue).subscribe(n=>{(0,h.A)(function*(){n=s._copilotChatService.mapSessions(n),s._updateCurrentSessionTitle(n,t);const i=yield t.$context.ActiveChats;t.$context.ActiveChats=[n,...i];const o=s._translationService.instant("Copilot.LiveAnnouncement.SessionCreated"),p=ae.String.format(o,n.caption);yield s._liveAnnouncementService.announce(p)})()})}_onActiveSessionLiveEvent(e,t){var s=this;(0,h.A)(function*(){try{if(e.id=!e.id||e.id===x.To?yield t.$context.CurrentCopilotSessionId:e.id,!e.id)return;e.caption&&s._updateCurrentSessionTitle(e,t),yield s._partiallyChatUpdate(e.id,t,n=>(n.caption=e.caption??n.caption,n.author=e.author??n.author,n.date=e.date??n.date,n.preview=e.preview??n.preview,s._copilotChatService.mapSessions(n)))}catch(n){console.error("Error updating chat session:",n)}})()}_partiallyChatUpdate(e,t,s){return(0,h.A)(function*(){const n=(yield t.$context.ActiveChats)?.findIndex(i=>i.id===e);if(n>=0){const i=s((yield t.$context.ActiveChats)[n]),o=yield t.$context.ActiveChats;o[n]=i,t.$context.ActiveChats=[...o]}})()}_updateCurrentSessionTitle(e,t){return(0,h.A)(function*(){e.id===(yield t.$context.CurrentCopilotSessionId)&&e.caption&&e.caption!==(yield t.$context.CurrentCopilotSessionTitle)&&(t.$context.CurrentCopilotSessionTitle=e.caption)})()}_addToSubscriptions(e,t){return(0,h.A)(function*(){const s=(yield e[Ds])??[];e[Ds]=s,s.push(...t)})()}_setFeatureAttributes(e){e.EnableChatFileHandling=this._featureValues["GenAIFeatures.UseChatFileHandling"]}_initChatsList(e,t){const s={type:"crt.CopilotChatListLoadRequest",rowsToLoadCount:15,searchFilter:null,isFirstLoad:!0,scopes:t,$context:e};return j.t.instance.process(s)}_loadProfile(e,t){const s={type:"crt.LoadChatProfileRequest",scopes:t,$context:e};return j.t.instance.process(s)}_initAttributes(e,t){t&&(t.savedInSessionId===this._userInfo.sessionId?(e.CurrentCopilotSessionId=t.lastChatId,typeof t.isChatsListVisible=="boolean"&&(e.ChatsListVisible=t.isChatsListVisible)):(e.CurrentCopilotSessionId=null,e.ChatsListVisible=!1),typeof t.isCombinedMode=="boolean"&&(e.IsCombinedMode=t.isCombinedMode),typeof t.combinedModeEnabled=="boolean"&&(e.CombinedModeEnabled=t.combinedModeEnabled))}_updateSessionTypingStatus(e,t,s){var n=this;return(0,h.A)(function*(){const i=t?.state,o=yield s.ActiveChats;if(i!==k.WaitingForUserMessage&&i!==k.WaitingForAssistantMessage)return;(yield s.CurrentCopilotSessionId)===e&&(i===k.WaitingForAssistantMessage?(s.IsTyping=!0,yield n._announceTyping(t)):i===k.WaitingForUserMessage&&(s.IsTyping=!1));const u=o?.find(m=>m.id===e);u&&(i===k.WaitingForAssistantMessage?u.isTyping=!0:i===k.WaitingForUserMessage&&(u.isTyping=!1))})()}_announceTyping(e){var t=this;return(0,h.A)(function*(){const s=t._translationService.instant("Copilot.LiveAnnouncement.Typing"),n=ae.String.format(s,e.rootIntentCaption||me.title);yield t._liveAnnouncementService.announce(n,"polite")})()}handle(e){var t=this;return(0,h.A)(function*(){yield t.next?.handle(e);const s=e.$context;t._setFeatureAttributes(s);const n=yield t._loadProfile(s,e.scopes);t._initAttributes(s,n);const i=t._copilotChatService.copilotSessionProgressEvent$().subscribe(p=>t._onSessionProgressEvent(p,e.$context)),o=t._copilotChatService.copilotMessageEvent$().subscribe(p=>{t._onMessageEvent(p,e)});t._copilotChatService.sessionUpdateEvent$().pipe((0,a.filter)(p=>p.eventType==="create")).subscribe(p=>{t._onActiveSessionEvent(p,e)}),t._copilotChatService.copilotSessionEvent$(t._copilotToChatConvertor).subscribe(p=>{t._onActiveSessionLiveEvent(p,e)}),yield t._initChatsList(s,e.scopes),yield t._addToSubscriptions(s,[i,o]),e.$context.CopilotContact=me.contact,t._initUserConsentData(e.$context),((yield e.$context.IsConversationVisible)===!0||(0,F.isEmpty)(n))&&((yield s.CurrentCopilotSessionId)?yield t._openConversation(e.$context,e):yield t._openNewConversation(e.$context,e)),yield t._initWatchNavigation(s)})()}};ut=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotChatInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["CopilotPanel"]}),(0,r.__param)(5,(0,d.Inject)(De.G)),(0,r.__param)(5,(0,js.j)(De.G)),(0,r.__metadata)("design:paramtypes",[V,Re,Xn.f,N.oq,d.Injector,Qn.x,y.DW,S.TranslateService])],ut);let ks=class extends X.S{};ks=(0,r.__decorate)([(0,z.$)({type:"crt.CopilotChatModeRequest"})],ks);let pt=class extends f.l{_handleConversationOpen(e,t){return(0,h.A)(function*(){if((yield e.ChatsListVisible)&&(yield e.IsCombinedMode)){const s={type:"crt.CopilotNewChatRequest",scopes:t.scopes,$context:e};yield j.t.instance.process(s)}})()}_saveProfile(e,t){return(0,h.A)(function*(){const s={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield j.t.instance.process(s)})()}handle(e){var t=this;return(0,h.A)(function*(){yield t.next?.handle(e);const s=e.$context;s.IsCombinedMode=e.isCombined,yield t._handleConversationOpen(s,e),t._saveProfile(s,e.scopes)})()}};pt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotChatModeHandler",requestType:"crt.CopilotChatModeRequest",scopes:["CopilotPanel"]})],pt);var ze=l(48534),Ge=l(85040);let mt=class extends f.l{constructor(e){super(),this._copilotPanelCode="Copilot",this._copilotToEditorCommunicationService=e.get(ze.i)}handle(e){var t=this;return(0,h.A)(function*(){e.sidebarCode===t._copilotPanelCode&&t._copilotToEditorCommunicationService.notify({editorAction:Ge.u.RemoveHighlighting,selection:ae.String.empty}),yield t.next?.handle(e)})()}};mt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotClosePanelHandler",requestType:"crt.HandleSidebarCloseRequest"}),(0,r.__metadata)("design:paramtypes",[d.Injector])],mt);var We=l(82517),Ke=l(7471),Zn=l(67354);let gt=class extends f.l{constructor(e){super(),this.injector=e,this._intentManager=this.injector.get(J.R),this._dialogService=this.injector.get(Ke.o),this._translateService=this.injector.get(S.TranslateService)}_refreshGrid(e){var t=this;return(0,h.A)(function*(){const s=e.$context,i={type:"crt.LoadDataRequest",scopes:e.scopes,config:{loadType:We.I.Reload,useLastLoadParameters:!0},$context:s,dataSourceName:"ActionsDetailDS"};yield t.handlerChain.process(i)})()}handle(e){var t=this;return(0,h.A)(function*(){const s=t._translateService.instant("Copilot.DeleteRecordConfirmation");if((yield(0,a.firstValueFrom)(t._dialogService.openConfirmationDialog(s)))===Zn.ch.result){const i=yield(0,a.firstValueFrom)(t._intentManager.deleteAction(e.intentId,e.recordId));if(!i.success)throw new Error(i.errorInfo?.message);yield t._refreshGrid(e)}})()}};gt=(0,r.__decorate)([(0,C.l)({requestType:"crt.DeleteActionFromIntentRequest",type:"crt.CopilotDeleteIntentActionHandler",scopes:["AISkills_FormPage","AIAgents_FormPage"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],gt);var _t=l(99298);let Ct=class extends X.S{};Ct=(0,r.__decorate)([(0,z.$)({type:"crt.DeleteRecordRequest"})],Ct);var Bs=l(49159),ft=l(85604),Yn=l(31774);let zs=class extends Ct{};zs=(0,r.__decorate)([(0,z.$)({type:"crt.DeleteSubIntentRequest"})],zs);let St=class extends f.l{constructor(e){super(),this.injector=e,this._intentManager=this.injector.get(J.R),this._messageDialogProvider=this.injector.get(Yn.r),this._translateService=this.injector.get(S.TranslateService),this._maskService=this.injector.get(_t.V)}_reloadDatasource(e){var t=this;return(0,h.A)(function*(){const{$context:s,scopes:n,reloadDataSourceName:i}=e;i&&(yield t.handlerChain.process({type:"crt.LoadDataRequest",dataSourceName:i,config:{loadType:We.I.Reload},$context:s,scopes:n}))})()}handle(e){var t=this;return(0,h.A)(function*(){const s=t._translateService.instant("Copilot.DeleteRecordConfirmation");if(!(yield(0,a.firstValueFrom)(t._messageDialogProvider.confirmation(s))))return t.next?.handle(e);const i="REMOVE_INTENT_RELATION",{$context:o}=e;yield t._maskService.showMask(i,o);try{yield(0,a.firstValueFrom)(t._intentManager.deleteSubIntent(e.parentIntentId,e.recordId)),Bs.q.instance.notify({modelId:(0,x.qv)(),dataSchemaName:"CopilotAgentSubSkill",type:ft.M.Delete,payload:{primaryAttributesValues:[[{name:"Id",value:e.recordId}]]}}),yield t._reloadDatasource(e)}finally{yield t._maskService.hideMask(i,o)}return t.next?.handle(e)})()}};St=(0,r.__decorate)([(0,C.l)({requestType:"crt.DeleteSubIntentRequest",type:"crt.CopilotDeleteSubIntentHandler",scopes:["AIAgents_FormPage","AISkills_FormPage"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],St);let vt=class extends f.l{constructor(e){super(),this._userConsentService=e.get(v.F),this._copilotGtmService=e.get(G)}handle(e){var t=this;return(0,h.A)(function*(){t._userConsentService.giveUserConsent(e.consentCode).subscribe(()=>{e.$context.IsCopilotChatVisible=!0,e.$context.IsCopilotDisclaimerVisible=!1}),yield t._copilotGtmService.sendGTMData({action:"consent_accepted"}),yield t.next?.handle(e)})()}};vt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotDisclaimerAcceptHandler",requestType:"crt.CopilotDisclaimerAcceptRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],vt);let yt=class extends f.l{constructor(e){super(),this._copilotService=e.get(Z)}handle(e){var t=this;return(0,h.A)(function*(){const s=yield t._copilotService.executeIntent(e.intentName,e.additionalPromptText,e.parameters);return yield t.next?.handle(e),s})()}};yt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotExecuteIntentHandler",requestType:"crt.CopilotExecuteIntentRequest"}),(0,r.__metadata)("design:paramtypes",[d.Injector])],yt);let It=class extends f.l{constructor(e){super(),this._copilotService=e.get(Z)}_isObjectResponse(e){return!!e&&e===Object(e)&&!Array.isArray(e)}handle(e){var t=this;return(0,h.A)(function*(){const s=yield t._copilotService.getAvailableIntents(e.intentNames,e.mode),n=yield t.next?.handle(e);return t._isObjectResponse(n)?{...s,...n}:s})()}};It=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotGetAvailableIntentsHandler",requestType:"crt.CopilotGetAvailableIntentsRequest"}),(0,r.__metadata)("design:paramtypes",[d.Injector])],It);var qn=l(92009);let Mt=class extends f.l{constructor(e){super(),this._schemaService=e,this._defValueHandlers=new Map([["CopilotIntentParameter",this._handleCopilotIntentParameterDefValues],["SysSchemaOperationRight",this._handleSysSchemaOperationRightDefValues]])}_handleCopilotIntentParameterDefValues(e,t){const s=e.dataGridName.replace("Detail","");return t.push({attributeName:"SourceCollection",value:s}),t.push({attributeName:"DataValueTypeUId",value:de.Q[$.r.MAXSIZE_TEXT].id}),Promise.resolve()}_handleSysSchemaOperationRightDefValues(e,t){return(0,h.A)(function*(){const s=yield e.$context.Id;t.push({attributeName:"SysSchemaUId",value:s}),t.push({attributeName:"Operation",value:7})})()}_getDataGridViewConfig(e){return this._schemaService.getViewConfigInfoByProperty("type","crt.DataGrid")?.map(t=>t?.viewConfig)?.find(t=>t?.name===e)??null}_getIsSupportedEntitySchemaName(e){return this._defValueHandlers.has(e)}handle(e){var t=this;return(0,h.A)(function*(){const{dataGridName:s,defaultValues:n}=e,i=e.$context,p=t._getDataGridViewConfig(s)?.items?.toString().slice(1);if(p){const m=i.getBoundDataSchemaByAttributePath(p).dataSourceConfig.config.entitySchemaName;if(!t._getIsSupportedEntitySchemaName(m))return t.next?.handle(e);yield t._defValueHandlers.get(m)(e,n)}return t.next?.handle(e)})()}};Mt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotIntentDetailCreateItemHandler",requestType:"crt.DataGridCreateItemRequest",scopes:["AISkills_FormPage"]}),(0,r.__metadata)("design:paramtypes",[qn.R])],Mt);var Gs=l(73743);let At=class extends f.l{constructor(){super(...arguments),this._apiMode=Gs.$E.get(Gs.aA.Api)}handle(e){var t=this;return(0,h.A)(function*(){if(e.attributeName==="PDS_Mode"){const s=e.value?e.value:yield e.$context.PDS_Mode;e.$context.IsApiMode=s?s.value===t._apiMode:!1}return t.next?.handle(e)})()}};At=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotIntentModeChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["AISkills_FormPage"]})],At);var ei=l(50237),ti=l(5704),si=l(29025),ni=l(53163),Je=l(38071);class Ws extends f.l{constructor(e){super(),this._featureService=e.get(Je.wf)}_initializeFeatureAttributes(e){var t=this;return(0,h.A)(function*(){const s=t.featureToAttributeMap;for(const n of s){const{featureCode:i,attributeName:o,invert:p}=n,u=yield(0,a.lastValueFrom)(t._featureService.getFeatureState(i));e[o]=p?!u:u}})()}_processPredefinedFilter(e,t){return(0,h.A)(function*(){const s=yield e[t.filterAttributeName],n=yield e[t.filterValueAttributeName];if(s){const i=ei.b.fromJson(s);i.filters.forEach(o=>{o instanceof ti.x&&o.leftExpression instanceof si.g&&o.leftExpression.columnPath===t.filterEntityColumnPath&&o.rightExpression instanceof ni.J&&(o.rightExpression.parameter.value=n,e[t.filterAttributeName]=i.toJson())})}})()}_initializePredefinedFilterValues(e){var t=this;return(0,h.A)(function*(){const s=t.predefinedFilterValueMap;for(const n of s)yield t._processPredefinedFilter(e,n)})()}handle(e){var t=this;return(0,h.A)(function*(){const s=e.$context;yield t._initializeFeatureAttributes(s),yield t.next?.handle(e),yield t._initializePredefinedFilterValues(s)})()}}let Et=class extends Ws{constructor(e){super(e),this._availableDataValueTypes=[$.r.Date,$.r.Time,$.r.DateTime,$.r.Guid,$.r.Boolean,$.r.LONG_TEXT,$.r.MAXSIZE_TEXT,$.r.Integer,$.r.FLOAT2,$.r.Money],this._translateService=e.get(S.TranslateService)}get featureToAttributeMap(){return[{featureCode:"GenAIFeatures.UseIntentSchemaOperationRights",attributeName:"EnableRightsManagementUI"},{featureCode:"GenAIFeatures.UseFileHandling",attributeName:"EnableAttachmentsUI"},{featureCode:"GenAIFeatures.DisableSkillParametersUi",attributeName:"EnableParametersUI",invert:!0},{featureCode:"GenAIFeatures.MultiLlmSupport",attributeName:"EnableMultiLlmSupport"},{featureCode:"GenAIFeatures.EnableResponseFormatJsonSchemaUI",attributeName:"EnableResponseJsonSchemaUI"}]}get predefinedFilterValueMap(){return[{filterAttributeName:"IntentFileList_PredefinedFilter",filterValueAttributeName:"Id",filterEntityColumnPath:"IntentUId"}]}_getDataValueTypeLookupValues(e=!1){const t=[...this._availableDataValueTypes];return e&&t.push($.r.COMPOSITE_OBJECT_LIST),Object.keys(de.Q).filter(s=>{const n=de.Q[s];return t.includes(n.type)}).map(s=>{const n=de.Q[s];return{displayValue:this._translateService.instant(n.translateKey),value:n.id}}).sort((s,n)=>s.displayValue.localeCompare(n.displayValue))}handle(e){var t=()=>super.handle,s=this;return(0,h.A)(function*(){const n=e.$context;n.AvailableInputDataValueTypes=s._getDataValueTypeLookupValues(!0),n.AvailableOutputDataValueTypes=s._getDataValueTypeLookupValues(),yield t().call(s,e)})()}};Et=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotIntentPageInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["AISkills_FormPage"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],Et);let Pt=class extends Ws{constructor(e){super(e)}get featureToAttributeMap(){return[{featureCode:"GenAIFeatures.UseFileHandling",attributeName:"EnableAttachmentsUI"},{featureCode:"GenAIFeatures.UseIntentSchemaOperationRights",attributeName:"EnableRightsManagementUI"},{featureCode:"GenAIFeatures.MultiLlmSupport",attributeName:"EnableMultiLlmSupport"}]}get predefinedFilterValueMap(){return[{filterAttributeName:"AgentFileList_PredefinedFilter",filterValueAttributeName:"Id",filterEntityColumnPath:"IntentUId"}]}};Pt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotAgentPageInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["AIAgents_FormPage"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],Pt);let xt=class extends f.l{handle(e){var t=this;return(0,h.A)(function*(){const i=yield(yield e.$context[e.collectionName])?.findByPrimaryAttribute(e.primaryColumnValue);i&&(i[e.attributeName]=e.attributeValue??de.Q[$.r.MAXSIZE_TEXT].id),yield t.next?.handle(e)})()}};xt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotIntentParameterDataValueTypeChangeHandler",requestType:"crt.CopilotIntentParameterDataValueTypeChangeRequest",scopes:["AISkills_FormPage"]})],xt);var Ks=l(65288);let bt=class extends f.l{handle(e){var t=this;return(0,h.A)(function*(){const s=e.$context,n=yield t.next.handle(e);if(n){const o=(e.recordIds??[]).map(p=>(0,a.lastValueFrom)(s.delete(e.dataSourceName,[{type:Ks.E.PrimaryColumnValue,value:p}])));yield Promise.all(o)}return n})()}};bt=(0,r.__decorate)([(0,C.l)({requestType:"crt.DeleteRecordsRequest",type:"crt.CopilotIntentParameterDeleteItemHandler",scopes:["AISkills_FormPage"]})],bt);let Tt=class extends f.l{_extractTemplateParameters(e){const t=/\[#\s*([a-zA-Z_][a-zA-Z0-9_.]*)\s*#]/g,s=new Set;let n;for(;(n=t.exec(e))!==null;)s.add(n[1]);return Array.from(s)}handle(e){var t=this;return(0,h.A)(function*(){if(e.attributeName==="PDS_Prompt"){const s=e.$context;s.Prompt_tooltip=null;const n=e.value?e.value:yield s.PDS_Prompt,i=t._extractTemplateParameters(n);if(i.length>0){const p=(yield s.InputParametersDetail).map(m=>m.attributes.InputParametersDS_Code),u=i.filter(m=>!p.includes(m));if(u.length>0){const m=yield s.Resources.Strings.MissingPromptParameterWarning;s.Prompt_tooltip=m.replace("{0}",u.join(", "))}}}return t.next?.handle(e)})()}};Tt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotIntentPromptChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["AISkills_FormPage","AIAgents_FormPage"]})],Tt);var Js=l(22592);const ii="workspace-explorer-items-reload";var ai=l(97502);const oi=["InputParametersDetail","OutputParametersDetail"];let Rt=class extends f.l{constructor(e,t,s,n,i,o){super(),this._broadcastChannelFactory=e,this._baseViewModelProcessValidationResultService=t,this._notifyService=s,this._intentManager=n,this._maskService=i,this._init(),this._featureService=o.get(Je.wf)}_init(){this._workspaceReloadBroadcastService=this._broadcastChannelFactory.createInstance(ii)}_saveDataSafely(e){return e().catch(t=>[this._createFailedSaveResult(t?.message)])}_createFailedSaveResult(e){return{success:!1,rowsAffected:0,errorInfo:e}}_saveInnerViewModelCollection(e,t,s){var n=this;return(0,h.A)(function*(){const i={type:"crt.SaveCollectionPrimaryDataRequest",$context:e,collectionAttributeName:t,scopes:s};return yield n.handlerChain.process(i)})()}_validatePrimaryModel(e){var t=this;return(0,h.A)(function*(){const s=yield e.getPrimaryModelName();if(!(yield e.isValid(s))){const i=yield e.validate(s),o=yield t._baseViewModelProcessValidationResultService.getValidationErrorMessage(e,i);throw new Error(o)}})()}_showErrorDialog(e){var t=this;return(0,h.A)(function*(){const s=e?.message;s&&(yield t._notifyService.show({message:s}))})()}_aggregateDataSourceSaveResults(e){const t=e.map(s=>s?.errorInfo).filter(Boolean);return{success:e.length===0||e.every(s=>s?.success),errors:t.length===0?void 0:t.join(`
`)}}_handleOutputFormat(e){var t=this;return(0,h.A)(function*(){if(!(yield(0,a.lastValueFrom)(t._featureService.getFeatureState("GenAIFeatures.EnableResponseFormatJsonSchemaUI"))))return;if(yield e.IsJsonStructureMode){const o=(yield e.OutputParametersDetail).map(function(){var m=(0,h.A)(function*(_){return yield _.OutputParametersDS_Id});return function(_){return m.apply(this,arguments)}}()),u=(yield Promise.all(o)).map(m=>(0,a.lastValueFrom)(e.delete("OutputParametersDS",[{type:Ks.E.PrimaryColumnValue,value:m}])));yield Promise.all(u)}else e.PDS_ResponseFormatJsonSchema=null})()}_handleApiModeSave(e,t){var s=this;return(0,h.A)(function*(){const n="RECORD_SAVING";yield s._maskService.showMask(n,e),yield s._handleOutputFormat(e);try{yield s._validatePrimaryModel(e);const i=oi.map(u=>s._saveDataSafely(()=>s._saveInnerViewModelCollection(e,u,t))),o=yield Promise.all(i),p=s._aggregateDataSourceSaveResults(o.flat());if(!p.success)throw new Error(p.errors)}catch(i){return yield s._showErrorDialog(i),!1}finally{yield s._maskService.hideMask(n,e)}return!0})()}handle(e){var t=this;return(0,h.A)(function*(){const s=e.$context;if((yield s.IsApiMode)&&!(yield t._handleApiModeSave(s,e.scopes)))return!1;const n=yield t.next?.handle(e);if(n){const i=yield s.PDS_Id,o=yield s.PDS_ParentIntentId;let p;o?(yield(0,a.lastValueFrom)(t._intentManager.createSubIntent(o,i)),p=ft.M.Create):p=ft.M.Update,Bs.q.instance.notify({modelId:(0,x.qv)(),dataSchemaName:"CopilotAgentSubSkill",type:p,payload:{primaryAttributesValues:[[{name:"Id",value:i}]]}})}return t._workspaceReloadBroadcastService.publish(),n})()}};Rt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotIntentSaveHandler",requestType:"crt.SaveRecordRequest",scopes:["AISkills_FormPage","AIAgents_FormPage"]}),(0,r.__param)(4,(0,js.j)(_t.V)),(0,r.__metadata)("design:paramtypes",[y.Vx,ai.i,lt.F,J.R,Js.s,d.Injector])],Rt);var Dt=l(13555);let Nt=class extends f.l{constructor(e){super(),this._copilotChatService=e.get(te),this._userInfo=e.get(N.oq),this._copilotToChatConvertor=e.get(Q),this._chatDraftService=e.get(Dt.X),this._copilotGtmService=e.get(G)}_getConvertedMessages(e){return this._copilotToChatConvertor.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId})}_addMessageToConversation(e,t,s){var n=this;return(0,h.A)(function*(){const i=yield e.$context[s],o=new Set(i.map(u=>u.id)),p=n._getConvertedMessages(t).filter(u=>!o.has(u.id));e.$context[s]=[...i,...p]})()}_saveProfile(e,t){return(0,h.A)(function*(){const s={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield j.t.instance.process(s)})()}handle(e){var t=this;return(0,h.A)(function*(){const s=e.attributesMapping,n=s?.chatInput,i=s.chatId;let o=yield e.$context[i];if(!(0,F.isEmpty)(n)){const p=yield e.$context[n];e.$context[n]="",t._chatDraftService.clearDraft(o),(0,F.isEmpty)(o)?(o=(0,x.qv)(),e.$context[i]=o,e.$context.IsTyping=!0,yield t._saveProfile(e.$context,e.scopes)):e.$context[i]=o,yield t._copilotGtmService.sendGTMData({action:"query_submitted",primaryColumnValue:o});const u=yield t._copilotChatService.sayToSessionWithResponse(p,o);if(!u)e.$context[n]=p;else if(u?.messages.length){const m=s?.chatMessages;!(0,F.isEmpty)(m)&&(yield e.$context[i])===o&&(yield t._addMessageToConversation(e,u.messages,m))}}yield t.next?.handle(e)})()}};Nt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotMessageEditorSendHandler",requestType:"crt.MessageEditorSendRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],Nt);var Qs=l(96158),Xs=l(43778);let Qe=class extends f.l{constructor(e){super(),this._injector=e,this._translateService=this._injector.get(S.TranslateService),this._chatDraftService=this._injector.get(Dt.X)}_setDefaultValuesIfNeeded(e){e.chatMessagesAttributeName??="ChatMessages",e.sessionIdAttributeName??="CurrentCopilotSessionId",e.sessionTitleAttributeName??="CurrentCopilotSessionTitle",e.conversationEventAttributeName??="ConversationEvent"}_resetMessageEditorInputFocus(e){e.$context.MessageEditorInputAction=Qs.g.Focus,setTimeout(()=>{e.$context.MessageEditorInputAction=""},0)}saveProfile(e,t){return(0,h.A)(function*(){const s={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield j.t.instance.process(s)})()}handle(e){var t=this;return(0,h.A)(function*(){t._setDefaultValuesIfNeeded(e);const s=e.$context;!(0,F.isEmpty)(e.chatMessagesAttributeName)&&!(0,F.isEmpty)(e.conversationEventAttributeName)&&(s[e.chatMessagesAttributeName]=[],s[e.conversationEventAttributeName]=[{name:Xs.R}]),s[e.sessionIdAttributeName]=null,s[e.sessionTitleAttributeName]=t._translateService.instant("Copilot.NewChatCaption"),(yield e.$context.IsCombinedMode)||(e.$context.ChatsListVisible=!1,e.$context.IsTyping=!1),e.$context.ChatInput="",setTimeout(()=>{e.$context.ChatInput=t._chatDraftService.getDraft(null),t._resetMessageEditorInputFocus(e)},0),yield t.saveProfile(e.$context,e.scopes),yield t.next?.handle(e)})()}};Qe=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotNewChatHandler",requestType:"crt.CopilotNewChatRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],Qe);var Zs=l(61541);let Lt=class extends f.l{constructor(e){super(),this.injector=e,this._intentManager=this.injector.get(J.R)}_getModelInitConfig(e){return(0,h.A)(function*(){const t=e.modelInitConfigs,s=yield e.getPrimaryModelName();return t?.find(n=>n.name===s)})()}_getIntent(e,t){var s=this;return(0,h.A)(function*(){let n;const o=(yield e.getPrimaryDataSchema())?.name;return o==="CopilotIntent"||o==="CopilotAgent"?n=yield(0,a.firstValueFrom)(s._intentManager.getIntent(t)):o==="CopilotAction"&&(n=yield(0,a.firstValueFrom)(s._intentManager.getIntentByActionUId(t))),n})()}_disableCodeField(e){const t=e.getAttributeNameByViewItemName("Code");e.disableAttributeValidator(t,"CodePrefixValidator"),e.setAttributePropertyValue(t,"readonly",!0)}handle(e){var t=this;return(0,h.A)(function*(){yield t.next?.handle(e);const s=e.$context,n=yield t._getModelInitConfig(s);if(!(n?.action===Zs.n.Edit))return;(yield t._getIntent(s,n?.recordId))?.ExtendParent&&t._disableCodeField(s)})()}};Lt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotPageDisableCodeFieldHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["AISkills_FormPage","AIProcessActions_FormPage","AIAgents_FormPage"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],Lt);const Y={process:"ProcessSchemaUId",params:"PDS_Params"};let wt=class extends f.l{constructor(e){super(),this._customEventService=e}_getIsAddAction(e){return(0,h.A)(function*(){const t=e.modelInitConfigs,s=yield e.getPrimaryModelName();return t?.find(i=>i.name===s)?.action===Zs.n.Add})()}handle(e){var t=this;return(0,h.A)(function*(){const s=e.$context;s[Y.process]=null;const n=yield t.next?.handle(e);if(yield t._getIsAddAction(s))return n;const i=yield s.ProcessDesignerInstanceId;return yield new Promise(o=>{const p={designerInstanceId:i,callback:o};t._customEventService.createOutboundChannel("cancelProcessSchemaChanges").next(p)}),n})()}};wt=(0,r.__decorate)([(0,C.l)({requestType:"crt.CancelRecordChangesRequest",type:"crt.CopilotProcessActionsCancelRecordHandler",scopes:["AIProcessActions_FormPage"]}),(0,r.__metadata)("design:paramtypes",[y.Dj])],wt);var Ys=l(89285),qs=l(32053);function en(c){return $t.apply(this,arguments)}function $t(){return $t=(0,h.A)(function*(c){const e="ProcessDesignerInstanceId";let t=yield c[e];t||(t=(0,x.qv)(),c[e]=t)}),$t.apply(this,arguments)}let Ft=class extends f.l{constructor(){super(...arguments),this._statusFlags=["ProcessSchemaIsChanged","HasUnsavedData",qs.j7,Y.process]}_handleProcessChange(e){if(e.attributeName===Y.process&&!e.silent){const t={processSchemaUId:e.value};e.$context[Y.params]=JSON.stringify(t)}}_handleCreateModel(e){return(0,h.A)(function*(){e.attributeName===qs.yM&&e.value===Ys.b.Create&&(e.$context[Y.process]=x.To,yield en(e.$context))})()}handle(e){var t=this;return(0,h.A)(function*(){if(t._handleProcessChange(e),yield t._handleCreateModel(e),e.attributeName==="ProcessSchemaIsLoaded"&&e.value){const s=yield e.$context.getPrimaryModelName();e.$context.getModelByName(s).setLoadedState()}else if(t._statusFlags.includes(e.attributeName)){const s=yield e.$context[Y.process],n=yield e.$context.ProcessSchemaIsLoaded,i=yield e.$context.ProcessSchemaIsChanged,o=yield e.$context.HasUnsavedData,p=yield e.$context.IsChanged;e.$context.ProcessActionHasUnsavedData=n&&s!==x.To&&(o||p||i)}return t.next?.handle(e)})()}};Ft=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotProcessActionsPageAttributeChangeHandler",requestType:"crt.HandleViewModelAttributeChangeRequest",scopes:["AIProcessActions_FormPage"]})],Ft);let Ut=class extends f.l{_subscribeParamsLoaded(e){const t=new a.Subscription;t.add(e.events$.pipe((0,a.filter)(({type:s})=>s==="finish-load-model-attributes"),(0,a.filter)(({payload:s})=>s[Y.params]),(0,a.switchMap)(()=>e[Y.params]),(0,a.filter)(s=>!!s)).subscribe({next:function(){var s=(0,h.A)(function*(n){let i;try{i=JSON.parse(n).processSchemaUId}catch(u){console.error(`params = ${n}
${u?.message}`)}const o={silent:!0},p={[Y.process]:i};e.setValue(p,o),yield en(e)});return function(i){return s.apply(this,arguments)}}(),complete:()=>{t.unsubscribe()}}))}handle(e){var t=this;return(0,h.A)(function*(){yield t.next?.handle(e),t._subscribeParamsLoaded(e.$context)})()}};Ut=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotProcessActionsPageInitHandler",requestType:"crt.HandleViewModelInitRequest",scopes:["AIProcessActions_FormPage"]})],Ut);let Vt=class extends f.l{constructor(e,t){super(),this._customEventService=e,this._translateService=t}_performDesignerSave(e,t){var s=this;return(0,h.A)(function*(){const n=yield e.ProcessDesignerInstanceId;return new Promise(i=>{const o={designerInstanceId:n,needSaveNewVersion:t,saveCallback:i};s._customEventService.createOutboundChannel("saveProcessSchema").next(o)})})()}_showDesignerValidationErrorNotification(e){var t=this;return(0,h.A)(function*(){const s={type:"crt.NotificationRequest",$context:e,message:"Dialog.ProcessSchemaSavedWithValidationError"};yield t.handlerChain.process(s)})()}handle(e){var t=this;return(0,h.A)(function*(){const s=e.$context,n=e.config,i=n?n.needSaveNewVersion:!1;if(!(yield s.isValid()))return yield t.next?.handle(e);const p=yield t._performDesignerSave(s,i);return p.isCanceled?!1:(p.isValid||(yield t._showDesignerValidationErrorNotification(s)),yield t.next?.handle(e))})()}};Vt=(0,r.__decorate)([(0,C.l)({requestType:"crt.SaveRecordRequest",type:"crt.CopilotProcessActionsPageSaveHandler",scopes:["AIProcessActions_FormPage"]}),(0,r.__metadata)("design:paramtypes",[y.Dj,S.TranslateService])],Vt);let Ot=class extends f.l{constructor(e){super(),this._copilotChatService=e.get(V),this._copilotToEditorCommunicationService=e.get(ze.i)}handle(e){var t=this;return(0,h.A)(function*(){yield t._copilotChatService.closeSession();const s=e.chatMessagesAttributeName,n=e.conversationEventAttributeName,i=e.$context;e.sessionIdAttributeName&&(i[e.sessionIdAttributeName]=null),!(0,F.isEmpty)(s)&&!(0,F.isEmpty)(n)&&(i[s]=[],i[n]=[{name:Xs.R}]),t._copilotToEditorCommunicationService.notify({editorAction:Ge.u.RemoveHighlighting}),yield t.next?.handle(e)})()}};Ot=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotRestartSessionHandler",requestType:"crt.CopilotRestartSessionRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],Ot);var tn=l(50002);let Ht=class extends f.l{constructor(e){super(),this._copilotPanelCode=Te.bd,this._sidebarStateService=e.get(Us.p),this._copilotChatService=e.get(te),this._translateService=e.get(S.TranslateService),this._copilotToEditorCommunicationService=e.get(ze.i),this._profileService=e.get(Fs.c),this._customEventService=e.get(y.Dj)}_getChatPanelProfileData(){var e=this;return(0,h.A)(function*(){return yield(0,a.firstValueFrom)(e._profileService.getProfile(Vs.j))})()}_getChatSessionId(){var e=this;return(0,h.A)(function*(){const t=yield e._getChatPanelProfileData(),s=yield(0,a.firstValueFrom)(e._sidebarStateService.opened.rootSidebar$);return t&&!t.isChatsListVisible&&s===e._copilotPanelCode?t.lastChatId:null})()}_getPrompt(e,t){return["Friendly","Formal","Shorten","Extend","Rephrase","AskCopilot"].includes(t)?`${this._translateService.instant(`Copilot.RewriteActionsPrompt.${t}`)}: ${e}`:e}handle(e){var t=this;return(0,h.A)(function*(){const s=yield e.$context[e.selectionAttributeName];if(!(0,F.isEmpty)(s)){t._copilotToEditorCommunicationService.notify({editorAction:Ge.u.SetHighlighting,selection:s});const n=t._getPrompt(s,e.rewriteAction),i=yield t._getChatSessionId();yield t._sidebarStateService.openRootSidebar(t._copilotPanelCode);const o=yield t._copilotChatService.sayToSessionWithResponse(n,i);!i&&o?.copilotSession&&t._customEventService.createOutboundChannel(Te.kl).next(o.copilotSession.id)}yield t.next?.handle(e)})()}};Ht=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotRewriteTextHandler",requestType:"crt.SelectionActionRequest",scopes:[tn.M.AllCards,"BasePageFreedomTemplate","BaseSidebarTemplate",tn.M.AllSections]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],Ht);let sn=class extends X.S{};sn=(0,r.__decorate)([(0,z.$)({type:"crt.CopilotSelectExistingProcessRequest",scopes:["AISkills_FormPage"]})],sn);let jt=class extends f.l{_saveIntent(e){var t=this;return(0,h.A)(function*(){const s=e.$context,n={type:"crt.SaveRecordRequest",preventCardClose:!0,preventCardStateChange:!0,$context:s,scopes:e.scopes},i=yield t.handlerChain.process(n);if(i){const o=yield s.getPrimaryModelName(),p=yield s.getPrimaryDataSchema(),u={type:"crt.LoadDataRequest",dataSourceName:o,parameters:[{type:"primaryColumnValue",value:p.primaryAttributeName}],$context:s,scopes:e.scopes};yield t.handlerChain.process(u)}return i})()}_getOpenLookupPageRequestConfig(e){var t=this;const{$context:s,scopes:n,caption:i,actionCode:o,intentId:p,packageUId:u}=e;return{type:"crt.OpenSelectionWindowRequest",$context:s,scopes:[...n],entitySchemaName:"VwProcessLib",caption:i,schemaName:"CopilotSelectExistingProcessForActionPage",afterClosed:function(){var m=(0,h.A)(function*(_){if(_.canceled)return;const O=yield _.getLookupValues(),[re]=O;if(re){const pi=re.value,mi={type:"crt.CreateRecordRequest",$context:s,entityName:"CopilotAction",defaultValues:[{attributeName:"Intent",value:p},{attributeName:"Code",value:o},{attributeName:"PackageUId",value:u},{attributeName:"Params",value:JSON.stringify({processSchemaUId:pi})}]};yield t.handlerChain.process(mi)}});return function(O){return m.apply(this,arguments)}}(),filtersConfig:{filterAttributes:[{name:"processEnabledFilter",loadOnChange:!1}],attributesConfig:{processEnabledFilter:{value:{items:{"a1dbfcfe-84e1-4bba-ac51-a83194bf2f6a":{filterType:1,comparisonType:3,isEnabled:!0,trimDateTimeParameterToDate:!1,leftExpression:{expressionType:0,columnPath:"Enabled"},isAggregative:!1,dataValueType:12,rightExpression:{expressionType:2,parameter:{dataValueType:12,value:!0}}}},logicalOperation:0,isEnabled:!0,filterType:6,rootSchemaName:"VwProcessLib"}}}},features:{disableLinks:!1}}}handle(e){var t=this;return(0,h.A)(function*(){if((yield e.$context.HasUnsavedData)&&!(yield t._saveIntent(e)))return;const n=t._getOpenLookupPageRequestConfig(e);return yield t.handlerChain.process(n),t.next?.handle(e)})()}};jt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotSelectExistingProcessHandler",requestType:"crt.CopilotSelectExistingProcessRequest",scopes:["AISkills_FormPage","AIAgents_FormPage"]})],jt);let nn=class extends X.S{};nn=(0,r.__decorate)([(0,z.$)({type:"crt.CopilotSelectExistingSkillRequest",scopes:["AIAgents_FormPage"]})],nn);let kt=class extends f.l{handle(e){var t=this;return(0,h.A)(function*(){return yield t.handlerChain.process({type:"crt.CopilotSelectExistingIntentRequest",sourceIntentId:e.agentId,selectionWindow:{caption:e.caption,entitySchemaName:"CopilotIntent",schemaName:"CopilotSelectExistingSkillForAgentPage",features:{disableLinks:!1}},reloadDataSources:["SubSkillsDetailDS"],selectedValueIsChild:!0,$context:e.$context,scopes:e.scopes}),t.next?.handle(e)})()}};kt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotSelectExistingSkillHandler",requestType:"crt.CopilotSelectExistingSkillRequest",scopes:["AIAgents_FormPage"]})],kt);let Bt=class extends f.l{constructor(e){super(),this.injector=e,this.intentManager=this.injector.get(J.R),this.maskService=this.injector.get(_t.V)}_saveRecord(e){const{$context:t,scopes:s}=e,n={type:"crt.SaveRecordRequest",preventCardClose:!0,preventCardStateChange:!0,$context:t,scopes:s};return this.handlerChain.process(n)}_createSelectionWindowRequest(e){const{$context:t,scopes:s,selectionWindow:n}=e;return{type:"crt.OpenSelectionWindowRequest",caption:n.caption,entitySchemaName:n.entitySchemaName,schemaName:n.schemaName,features:n.features,filtersConfig:n.filtersConfig,afterClosed:i=>this._handleSelectionResult(i,e),$context:t,scopes:[...s]}}_handleSelectionResult(e,t){var s=this;return(0,h.A)(function*(){if(e.canceled)return;const n=yield e.getLookupValues(),[i]=n;if(i){const o=i.value,p="CREATE_INTENT_RELATION",{$context:u}=t;yield s.maskService.showMask(p,u);try{yield s._createIntentRelation(t,o),yield s._reloadDataSource(t)}finally{yield s.maskService.hideMask(p,u)}}})()}_reloadDataSource(e){var t=this;return(0,h.A)(function*(){const{$context:s,reloadDataSources:n,scopes:i}=e,o=(n??[]).map(p=>t.handlerChain.process({type:"crt.LoadDataRequest",dataSourceName:p,config:{loadType:We.I.Reload},$context:s,scopes:i}));yield Promise.all(o)})()}_createIntentRelation(e,t){var s=this;return(0,h.A)(function*(){const{sourceIntentId:n,selectedValueIsChild:i}=e;let o,p;i?(o=n,p=t):(o=t,p=n),yield(0,a.lastValueFrom)(s.intentManager.createSubIntent(o,p))})()}handle(e){var t=this;return(0,h.A)(function*(){if((yield e.$context.HasUnsavedData)&&!(yield t._saveRecord(e)))return t.next?.handle(e);const n=t._createSelectionWindowRequest(e);return yield t.handlerChain.process(n),t.next?.handle(e)})()}};Bt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotSelectExistingIntentHandler",requestType:"crt.CopilotSelectExistingIntentRequest",scopes:["AIAgents_FormPage","AISkills_FormPage"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],Bt);let an=class extends X.S{};an=(0,r.__decorate)([(0,z.$)({type:"crt.CopilotShowDebugInfoRequest",scopes:["CopilotPanel"]})],an);let zt=class extends f.l{constructor(e){super(),this._copilotChatService=e.get(V),this._translateService=e.get(S.TranslateService),this._dialogService=e.get(Ke.o),this._maskService=e.get(Js.s),this._featureService=e.get(Je.wf)}_openDebugInfoPage(e,t,s){var n=this;return(0,h.A)(function*(){const i={schemaName:"AIDebugInfo",type:"crt.OpenPageRequest",$context:e.$context,skipUnsavedData:!0,parameters:{PlainInfo:s,DebugInfo:t}};yield n.handlerChain.process(i)})()}_useSyntaxHighlight(e){const t={strings:"#181818",booleans:"#219",numbers:"#164",keys:"#757575"};return e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e.replace(/("(\\u[[:alnum:]]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+-]?\d+)?)/g,s=>{let n=t.numbers;return s.startsWith('"')?n=s.endsWith(":")?t.keys:t.strings:["null","true","false"].includes(s)&&(n=t.booleans),`<span style="color:${n}">${s}</span>`})}_useIndentation(e){return e.replaceAll("\u2003","&emsp;").replaceAll("\\n","\\a").replaceAll(`
`,"<br>").replaceAll("\\a","\\n")}handle(e){var t=this;return(0,h.A)(function*(){const s=yield(0,a.lastValueFrom)(t._featureService.getFeatureState("ShowSystemMessagesFromCopilot"));yield t._maskService.showBodyMask();const n=e.sessionId,i=n?t._copilotChatService.getCopilotSessionMessages(n):t._copilotChatService.getInitialMessages$();yield(0,a.firstValueFrom)(i.pipe((0,a.map)(o=>s?o:o.slice(1)),(0,a.tap)(function(){var o=(0,h.A)(function*(p){if(!p||p.length===0){const _=t._translateService.instant("Copilot.DebugInfo.NoDebugInfo");yield t._maskService.hideBodyMask(),t._dialogService.openInfoDialog(_);return}const u=JSON.stringify(p,null,"\u2003");let m=t._useSyntaxHighlight(u);m=t._useIndentation(m),yield t._openDebugInfoPage(e,m,u),yield t._maskService.hideBodyMask()});return function(p){return o.apply(this,arguments)}}())))})()}};zt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotShowDebugInfoHandler",requestType:"crt.CopilotShowDebugInfoRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],zt);let Gt=class extends f.l{constructor(e){super(),this._copilotToEditorCommunicationService=e.get(ze.i)}handle(e){var t=this;return(0,h.A)(function*(){t._copilotToEditorCommunicationService?.notify({editorAction:Ge.u.RemoveHighlighting}),yield t.next?.handle(e)})()}};Gt=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotViewModelPauseHandler",requestType:"crt.HandleViewModelPauseRequest"}),(0,r.__metadata)("design:paramtypes",[d.Injector])],Gt);class Wt extends X.S{}class Kt extends f.l{constructor(e){super(),this.injector=e,this._initialCodeValueAttributeName="_InitialCodeValue",this.intentManager=this.injector.get(J.R)}loadCodes(e,t){return this.getCodes(e,t).pipe((0,a.tap)(s=>e[this.cacheAttributeName]=s))}handle(e){var t=this;return(0,h.A)(function*(){const s=e.$context;if(s.PrimaryModelMode!==Ys.b.Create){yield t.next?.handle(e);return}let n=yield s[t._initialCodeValueAttributeName];n||(n=yield t.initializeCodeValue(s,e),s[t._initialCodeValueAttributeName]=n);const i=yield s[e.valueAttributeName];if(!i){s[e.codeAttributeName]=n;return}const o=yield s[t.cacheAttributeName],u=(o?.length>0?(0,a.of)(o):t.loadCodes(s,e)).pipe((0,a.switchMap)(m=>t.generateCode(m,i)));s[e.codeAttributeName]=(yield(0,a.lastValueFrom)(u))??n,yield t.next?.handle(e)})()}}let on=class extends Wt{};on=(0,r.__decorate)([(0,z.$)({type:"crt.GenerateCopilotActionCodeValueRequest"})],on);let Jt=class extends Kt{constructor(e){super(e),this.cacheAttributeName="_ActionCodes_Cache"}getCodes(e,t){return(0,a.from)(e[t.intentAttributeName]).pipe((0,a.switchMap)(s=>this.intentManager.getIntent(s?.value).pipe((0,a.map)(n=>n.Actions.map(i=>i.Code)))))}generateCode(e,t){return this.intentManager.generateActionCode(e,t)}initializeCodeValue(e,t){return e[t.codeAttributeName]}};Jt=(0,r.__decorate)([(0,C.l)({type:"crt.GenerateCopilotActionCodeValueHandler",requestType:"crt.GenerateCopilotActionCodeValueRequest"}),(0,r.__metadata)("design:paramtypes",[d.Injector])],Jt);let rn=class extends Wt{};rn=(0,r.__decorate)([(0,z.$)({type:"crt.GenerateAgentCodeValueRequest"})],rn);let Qt=class extends Kt{constructor(e){super(e),this.cacheAttributeName="_AgentCodes_Cache"}getCodes(){return this.intentManager.getAllAgents()}generateCode(e,t){return this.intentManager.generateAgentCode(e,t)}initializeCodeValue(e,t){return(0,a.lastValueFrom)(this.loadCodes(e,t).pipe((0,a.switchMap)(s=>this.generateCode(s,""))))}};Qt=(0,r.__decorate)([(0,C.l)({type:"crt.GenerateAgentCodeValueRequestHandler",requestType:"crt.GenerateAgentCodeValueRequest"}),(0,r.__metadata)("design:paramtypes",[d.Injector])],Qt);let cn=class extends Wt{};cn=(0,r.__decorate)([(0,z.$)({type:"crt.GenerateSkillCodeValueRequest"})],cn);let Xt=class extends Kt{constructor(e){super(e),this.cacheAttributeName="_SkillCodes_Cache"}getCodes(){return this.intentManager.getAllSkills()}generateCode(e,t){return this.intentManager.generateSkillCode(e,t)}initializeCodeValue(e,t){return(0,a.lastValueFrom)(this.loadCodes(e,t).pipe((0,a.switchMap)(s=>this.generateCode(s,""))))}};Xt=(0,r.__decorate)([(0,C.l)({type:"crt.GenerateSkillCodeValueRequestHandler",requestType:"crt.GenerateSkillCodeValueRequest"}),(0,r.__metadata)("design:paramtypes",[d.Injector])],Xt);class gi extends X.S{constructor(){super(...arguments),this.needRefresh=!1}}let Zt=class extends f.l{constructor(e,t,s){super(),this._copilotChatService=e,this._userInfo=s,this._copilotToChatConvertor=t.get(Q),this._chatDraftService=t.get(Dt.X)}_resetPreviewMessageId(e,t){return(0,h.A)(function*(){const n=(yield t.ActiveChats)?.find(i=>i.id===e);n&&(n.previewMessageId="")})()}_getConvertedMessages(e){return e?this._copilotToChatConvertor.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId}):[]}_saveProfile(e,t){return(0,h.A)(function*(){const s={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield j.t.instance.process(s)})()}_fetchSessionPreview(e){var t=this;return(0,h.A)(function*(){try{return yield(0,a.lastValueFrom)(t._copilotChatService.getActiveSessionPreviewById(e))}catch{return null}})()}_getSessionTypingState(e,t){return(0,h.A)(function*(){return!!(yield t.ActiveChats)?.find(i=>i.id===e)?.isTyping})()}_createNewSession(e){return(0,h.A)(function*(){const t={type:"crt.CopilotNewChatRequest",scopes:e.scopes,$context:e.$context};yield j.t.instance.process(t)})()}handle(e){var t=this;return(0,h.A)(function*(){yield t.next?.handle(e);const s=e.session.id;if((0,F.isEmpty)(s)){t._createNewSession(e);return}const n=e.session.previewMessageId;if(!((yield e.$context.CurrentCopilotSessionId)!==s||e.needRefresh)&&(yield e.$context.CurrentCopilotSessionTitle)&&(yield e.$context.IsCombinedMode))return;e.$context.ChatsListVisible=!1,e.$context.ChatMessages=[],e.$context.ConversationLoading=!0;const o=(yield e.$context.ChatsSearchFilter)&&n?t._copilotChatService.getCopilotSearchMessagesBatch(s,n):t._copilotChatService.getCopilotSessionMessagesPagination(s,0,15,!0),p=t._getConvertedMessages(yield(0,a.lastValueFrom)(o.pipe((0,a.tap)(()=>{e.$context.ConversationLoading=!1,setTimeout(()=>{e.$context.MessageEditorInputAction=Qs.g.Focus},0)}),(0,a.catchError)(()=>(e.$context.ConversationLoading=!1,(0,a.of)([])))))),u=e.session.caption??(yield t._fetchSessionPreview(s))?.caption;if(!p||p.length===0||u===void 0){t._createNewSession(e);return}yield t._resetPreviewMessageId(s,e.$context),e.$context.CurrentCopilotSessionTitle=u,e.$context.IsTyping=yield t._getSessionTypingState(s,e.$context),e.$context.ChatMessages=p,e.$context.PreviewMessageId=n,e.$context.CurrentCopilotSessionId=s,e.$context.ChatInput=t._chatDraftService.getDraft(s),setTimeout(()=>e.$context.MessageEditorInputAction="",0),yield t._saveProfile(e.$context,e.scopes)})()}};Zt=(0,r.__decorate)([(0,C.l)({type:"crt.ChatSessionOpenHandler",requestType:"crt.ChatSessionOpenRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[V,d.Injector,N.oq])],Zt);class _i extends null{}let Yt=class extends f.l{_saveProfile(e,t){return(0,h.A)(function*(){const s={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield j.t.instance.process(s)})()}handle(e){var t=this;return(0,h.A)(function*(){yield t.next?.handle(e),e.$context.ChatsListVisible=!0,e.$context.ChatInput="",yield t._saveProfile(e.$context,e.scopes)})()}};Yt=(0,r.__decorate)([(0,C.l)({type:"crt.ChatListOpenHandler",requestType:"crt.ChatListOpenRequest",scopes:["CopilotPanel"]})],Yt);var ri=l(95145);class q{constructor(e,t,s){this._sysSettingsService=e,this._notifyService=t,this._translateService=s,this._defaultFileExtensions="txt,docx,pdf",this._defaultMaxFileSize=5,this._maxIntentFileSizeSettingName="CreatioAIMaxIntentFileSize",this._maxSessionFileSizeSettingName="CreatioAIMaxSessionFileSize",this._allowedFileExtensionsSettingName="CreatioAIAllowedFileExtensions",this._intentMaxSizeExceptionKey="IntentMaxSizeException",this._chatMaxSizeExceptionKey="ChatMaxSizeException",this._intentMissingTypeExceptionKey="IntentMissingTypeException",this._chatMissingTypeExceptionKey="ChatMissingTypeException",this._intentNotSupportedTypeExceptionKey="IntentTypeNotSupportedException",this._chatNotSupportedTypeExceptionKey="ChatTypeNotSupportedException"}_validateFile(e,t,s,n){if(e.size/1024/1024>t){const p=n?this._chatMaxSizeExceptionKey:this._intentMaxSizeExceptionKey,u=this._getLocalizedException(p,t.toString(),n?this._maxSessionFileSizeSettingName:this._maxIntentFileSizeSettingName);throw new Error(u)}const o=e.name.includes(".")?e.name.split(".").pop()?.toLowerCase():null;if(!o){const p=this._getLocalizedException(n?this._chatMissingTypeExceptionKey:this._intentMissingTypeExceptionKey,s.join(","));throw new Error(p)}if(!s.includes(o)){const p=this._getLocalizedException(n?this._chatNotSupportedTypeExceptionKey:this._intentNotSupportedTypeExceptionKey,o,s.join(","));throw new Error(p)}}_getAllowedFileExtensionsSetting(){var e=this;return(0,h.A)(function*(){return(yield(0,a.lastValueFrom)(e._sysSettingsService.getByCode(e._allowedFileExtensionsSettingName)))?.value??e._defaultFileExtensions})()}_getAllowedFileExtensions(){var e=this;return(0,h.A)(function*(){return(yield e._getAllowedFileExtensionsSetting()).split(",").map(t=>t.trim())})()}_getMaxSizeSystemSetting(e){var t=this;return(0,h.A)(function*(){return(yield(0,a.lastValueFrom)(t._sysSettingsService.getByCode(e)))?.value??t._defaultMaxFileSize})()}_showErrorDialog(e){var t=this;return(0,h.A)(function*(){const s=e?.message;s&&(yield t._notifyService.show({message:s}))})()}_getLocalizedException(e,...t){const s=`Copilot.FileMessages.${e}`,n=this._translateService.instant(s);return ae.String.format(n,...t)}validateIntentFiles(...e){var t=this;return(0,h.A)(function*(){try{const s=yield t._getMaxSizeSystemSetting(t._maxIntentFileSizeSettingName),n=yield t._getAllowedFileExtensions();return e.forEach(i=>{t._validateFile(i,s,n,!1)}),!0}catch(s){return yield t._showErrorDialog(s),!1}})()}validateSessionFiles(...e){var t=this;return(0,h.A)(function*(){const s=yield t._getMaxSizeSystemSetting(t._maxSessionFileSizeSettingName),n=yield t._getAllowedFileExtensions();e.forEach(i=>{t._validateFile(i,s,n,!0)})})()}static{this.\u0275fac=function(t){return new(t||q)(d.\u0275\u0275inject(ri.A),d.\u0275\u0275inject(lt.F),d.\u0275\u0275inject(S.TranslateService))}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:q,factory:q.\u0275fac,providedIn:"root"})}}class oe{_getCurrentUserTime(){const n=(new Date().getTime()*1e4+621355968e9)/1e4;return new Date(n)}addErrorToChatMessages(e,t){const s={text:e,id:(0,x.qv)(),author:me.contact,date:this._getCurrentUserTime(),isBotMessage:!0,type:ke.X.Text,direction:pe.Tt.Incoming},n=Object.assign([],t);return n.push(s),n}static{this.\u0275fac=function(t){return new(t||oe)}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:oe,factory:oe.\u0275fac,providedIn:"root"})}}let qt=class extends f.l{constructor(e,t){super(),this._fileValidatorService=e,this._copilotChatMessageService=t}handle(e){var t=this;return(0,h.A)(function*(){if(e.recordId===null){const s=(0,x.qv)();e.$context.CurrentCopilotSessionId=s,e.recordId=s}if(e.files?.length)try{yield t._fileValidatorService.validateSessionFiles(...e.files)}catch(s){const n=yield e.$context.ChatMessages,i=s?.message;n&&i&&(e.$context.ChatMessages=t._copilotChatMessageService.addErrorToChatMessages(i,n));return}return t.next?.handle(e)})()}};qt=(0,r.__decorate)([(0,C.l)({requestType:"crt.UploadFileRequest",type:"crt.CopilotChatUploadFileHandler",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[q,oe])],qt);class Ci extends null{}let es=class extends f.l{_saveProfile(e,t){return(0,h.A)(function*(){const s={type:"crt.SaveChatProfileRequest",scopes:t,$context:e};yield j.t.instance.process(s)})()}handle(e){var t=this;return(0,h.A)(function*(){yield t.next?.handle(e);const s=yield e.$context.CombinedModeEnabled;e.$context.ChatsListVisible=!s,e.$context.IsCombinedMode=!s,e.$context.CombinedModeEnabled=!(yield e.$context.CombinedModeEnabled),yield t._saveProfile(e.$context,e.scopes)})()}};es=(0,r.__decorate)([(0,C.l)({type:"crt.CombinedChatViewHandler",requestType:"crt.CombinedChatViewRequest",scopes:["CopilotPanel"]})],es);let ts=class extends f.l{constructor(e){super(),this._copilotChatService=e.get(V)}handle(e){var t=this;return(0,h.A)(function*(){if(e.eventName==="sendMessage"){const n=(typeof e.message=="string"&&e.message||typeof e.payload?.text=="string"&&e.payload.text||"").trim(),i=yield e.$context.CurrentCopilotSessionId;yield t._copilotChatService.sayToSessionWithResponse(n,i)}yield t.next?.handle(e)})()}};ts=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotConversationMessageHandler",requestType:"crt.ChatMessageInteractionRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[d.Injector])],ts);let ss=class extends f.l{constructor(e){super(),this._fileValidatorService=e}handle(e){var t=this;return(0,h.A)(function*(){const s=yield t.next?.handle(e);return s.files.length&&!(yield t._fileValidatorService.validateIntentFiles(...s.files))?{files:[],errors:[]}:s})()}};ss=(0,r.__decorate)([(0,C.l)({requestType:"crt.SelectFileRequest",type:"crt.CopilotIntentUploadFileDialogHandler",scopes:["AISkills_FormPage","AIAgents_FormPage"]}),(0,r.__metadata)("design:paramtypes",[q])],ss);let ns=class extends f.l{constructor(e){super(),this._fileValidatorService=e}handle(e){var t=this;return(0,h.A)(function*(){if(!(e.files?.length&&!(yield t._fileValidatorService.validateIntentFiles(...e.files))))return t.next?.handle(e)})()}};ns=(0,r.__decorate)([(0,C.l)({requestType:"crt.UploadFileRequest",type:"crt.CopilotIntentUploadFileHandler",scopes:["AISkills_FormPage","AIAgents_FormPage"]}),(0,r.__metadata)("design:paramtypes",[q])],ns);let is=class extends f.l{constructor(e,t){super(),this._fileValidatorService=e,this._copilotChatMessageService=t}handle(e){var t=this;return(0,h.A)(function*(){const s=yield t.next?.handle(e);if(s.files.length)try{yield t._fileValidatorService.validateSessionFiles(...s.files)}catch(n){const i=yield e.$context.ChatMessages,o=n?.message;return i&&o&&(e.$context.ChatMessages=t._copilotChatMessageService.addErrorToChatMessages(o,i)),{files:[],errors:[]}}return s})()}};is=(0,r.__decorate)([(0,C.l)({requestType:"crt.SelectFileRequest",type:"crt.CopilotChatUploadFileDialogHandler",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[q,oe])],is);class fi extends X.S{constructor(){super(...arguments),this.offset=0,this.rows=15}}let as=class extends f.l{constructor(e,t,s){super(),this._copilotChatService=e,this._userInfo=s,this._rowsCount=15,this._allDataLoaded=!1,this._chatMessageCount=0,this._copilotToChatConvertor=t.get(Q)}_getConvertedMessages(e){return e?this._copilotToChatConvertor.convertMessages(e,{id:this._userInfo.contactId,name:this._userInfo.contactName,photoId:this._userInfo.photoId}):[]}_resetState(e,t){(e&&this._id!==e||t!==this._chatMessageCount)&&(this._allDataLoaded=!1)}handle(e){var t=this;return(0,h.A)(function*(){yield t.next?.handle(e);const s=yield e.$context.ChatMessages,n=e.sessionId||(yield e.$context.CurrentCopilotSessionId),i=e.rows||t._rowsCount;t._resetState(n,s?.length),t._id=n,t._chatMessageCount=s?.length||0,!(!n||t._allDataLoaded||s?.length<i)&&(e.$context.ConversationLoading=!0,yield(0,a.lastValueFrom)(t._copilotChatService.getCopilotSessionMessagesPagination(n,e.offset,i).pipe((0,a.map)(o=>{if(o?.length===0){t._allDataLoaded=!0;return}t._allDataLoaded=o.length<i;const p=t._getConvertedMessages(o);if(s&&s.length>0){const u=new Set(s.map(_=>_.id)),m=p.filter(_=>!u.has(_.id));e.$context.ChatMessages=[...m,...s]}else e.$context.ChatMessages=p}),(0,a.tap)(()=>{e.$context.ConversationLoading=!1}),(0,a.catchError)(()=>(e.$context.ConversationLoading=!1,(0,a.of)([]))))))})()}};as=(0,r.__decorate)([(0,C.l)({type:"crt.ChatSessionPaginationHandler",requestType:"crt.ChatSessionPaginationRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[V,d.Injector,N.oq])],as);let os=class extends f.l{constructor(e){super(),this._featureService=e}handle(e){var t=this;return(0,h.A)(function*(){const s=yield(0,a.lastValueFrom)(t._featureService.getFeatureState("GenAIFeatures.EnableResponseFormatJsonSchemaUI")),n=yield t.next?.handle(e);if(!s)return n;if(e.dataSourceName==="PDS"){const i=e.$context;(yield i.PDS_ResponseFormatJsonSchema)&&(i.IsJsonStructureMode=s)}return n})()}};os=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotIntentLoadDataHandler",requestType:"crt.LoadDataRequest",scopes:["AISkills_FormPage"]}),(0,r.__metadata)("design:paramtypes",[Je.wf])],os);let rs=class extends f.l{handle(e){var t=this;return(0,h.A)(function*(){const s=e.$context,i={type:"crt.LoadDataRequest",scopes:e.scopes,config:{loadType:We.I.Reload,useLastLoadParameters:!0},$context:s,dataSourceName:"PDS"};yield t.handlerChain.process(i),yield t.next?.handle(e)})()}};rs=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotResumeLlmModelsSectionHandler",requestType:"crt.HandleViewModelResumeRequest",scopes:["CreatioAIModels_ListPage"]})],rs);class Si extends null{}let cs=class extends Qe{constructor(e){super(e),this.injector=e,this._copilotChatService=this.injector.get(te)}handle(e){var t=()=>super.handle,s=this;return(0,h.A)(function*(){yield t().call(s,e),e.$context.CurrentCopilotSessionId=e.sessionId,yield s._copilotChatService.sayToSessionWithResponse(e.message,e.sessionId),yield s.saveProfile(e.$context,e.scopes),yield s.next?.handle(e)})()}};cs=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotNewChatWithMessageHandler",requestType:"crt.CopilotNewChatWithMessageRequest"}),(0,r.__metadata)("design:paramtypes",[d.Injector])],cs);var ci=l(51541),li=l(41483),di=l(61775);let ls=class extends f.l{constructor(e,t,s,n){super(),this._licenseService=e,this._cacheManager=t,this._translateService=s,this._dialogService=n,this._crtLlmProviderLicenseName="CreatioAIModels.CreatioNonDefaultProviders.Use",this._customLlmProviderLicenseName="CreatioAIModels.CustomProviders.Use",this._openAiLlmProviderId="3AD31D4A-7782-4D6D-B081-FED06141F9C5",this._azureLlmProviderId="8B5BD0D5-B962-4964-B12E-0C1DED928732"}_getCache(){return this._cacheManager.getOrCreate({type:li.P.Memory,name:"llmModel-LicenseStatus"})}_getLicenseStatus(e){var t=this;return(0,h.A)(function*(){const s=yield t._getCache();if(yield s.has(e))return yield s.get(e);const n=yield(0,a.firstValueFrom)(t._licenseService.getLicenseOperationStatuses([t._crtLlmProviderLicenseName,t._customLlmProviderLicenseName]));return yield s.set(t._crtLlmProviderLicenseName,n[t._crtLlmProviderLicenseName]),yield s.set(t._customLlmProviderLicenseName,n[t._customLlmProviderLicenseName]),n[e]})()}_getCanCreateLlmModel(e){const s=[this._openAiLlmProviderId,this._azureLlmProviderId].includes(e)?this._crtLlmProviderLicenseName:this._customLlmProviderLicenseName;return this._getLicenseStatus(s)}_getLlmProvider(e){return e.defaultValues.find(s=>s.attributeName==="LlmProvider")?.value}_showErrorMessage(){var e=this;return(0,h.A)(function*(){const t=e._translateService.instant("Copilot.LlmModelPage.NoLicenseToCreateLlmModel");yield(0,a.firstValueFrom)(e._dialogService.openErrorDialog(t))})()}handle(e){var t=this;return(0,h.A)(function*(){const s=t._getLlmProvider(e);if(!s)throw new Error("LlmProvider is not defined");if(yield t._getCanCreateLlmModel(s)){yield t.next?.handle(e);return}yield t._showErrorMessage()})()}};ls=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotCreateLlmModelRecordHandler",requestType:"crt.CreateRecordRequest",scopes:["CreatioAIModels_ListPage"]}),(0,r.__metadata)("design:paramtypes",[ci.X,di.G,S.TranslateService,Ke.o])],ls);var hi=l(37206);class vi extends null{}let ds=class extends hi.w{constructor(e){super(),this._copilotChatService=e}getCurrentChatId(e){return(0,h.A)(function*(){return yield e.$context.CurrentCopilotSessionId})()}getChatPreviews(e,t,s){return this._copilotChatService.getActiveSessionsWithPreview(e,t,s)}mapChatPreview(e){return this._copilotChatService.mapSessions(e)}getChatOpenRequest(e,t){return{type:"crt.ChatSessionOpenRequest",session:t,needRefresh:!0,scopes:e.scopes,$context:e.$context}}};ds=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotChatListLoadHandler",requestType:"crt.CopilotChatListLoadRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[V])],ds);class ge{constructor(){this._copilotService=(0,d.inject)(Z)}getContacts(e,t=0,s=15){return(0,a.from)(this._copilotService.getAvailableAgents()).pipe((0,a.map)(n=>n.filter(i=>!e||i.name.toLowerCase().includes(e.toLowerCase())).slice(t,t+s).map(i=>({displayValue:i.name,value:i.id,description:i.description}))))}static{this.\u0275fac=function(t){return new(t||ge)}}static{this.\u0275prov=d.\u0275\u0275defineInjectable({token:ge,factory:ge.\u0275fac,providedIn:"root"})}}class yi extends null{}let hs=class extends f.l{constructor(e){super(),this._copilotMentionsService=e}handle(e){var t=this;return(0,h.A)(function*(){yield t.next?.handle(e),e.initService(t._copilotMentionsService)})()}};hs=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotMentionInitHandler",requestType:"crt.CopilotMentionInitRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[ge])],hs);var ui=l(11395);class Ii extends null{}let us=class extends f.l{constructor(e,t,s,n){super(),this._dialogService=e,this._copilotChatService=t,this._liveAnnouncementService=s,this._translationService=n}_updateSessionInContext(e,t){var s=this;return(0,a.from)(Promise.all([e.$context.ActiveChats,e.$context.CurrentCopilotSessionTitle])).pipe((0,a.tap)(function(){var n=(0,h.A)(function*([i]){const o=i?.findIndex(u=>u.id===e.chatId);if(o>=0){const u=i[o];u.caption=t,i[o]=u,e.$context.ActiveChats=[...i]}if((yield e.$context.CurrentCopilotSessionId)===e.chatId){e.$context.CurrentCopilotSessionTitle=t;const u=s._translationService.instant("Copilot.LiveAnnouncement.ChatRenamed"),m=ae.String.format(u,t);yield s._liveAnnouncementService.announce(m)}});return function(i){return n.apply(this,arguments)}}()),(0,a.map)(()=>{}))}_updateSessionInStorage(e,t){return this._copilotChatService.renameSession(e,t).pipe((0,a.filter)(s=>s.success),(0,a.map)(()=>t))}handle(e){var t=this;return(0,h.A)(function*(){yield t.next?.handle(e);const s=yield e.$context.ActiveChats,n=s?.findIndex(i=>i.id===e.chatId);if(n>=0){const i=s[n];yield(0,a.firstValueFrom)(t._dialogService.open(ui.P,{panelClass:["rename-chat-dialog-window"],data:{chatTitle:i.caption}}).pipe((0,a.filter)(o=>!!o),(0,a.switchMap)(o=>t._updateSessionInStorage(e.chatId,o)),(0,a.switchMap)(o=>t._updateSessionInContext(e,o)),(0,a.defaultIfEmpty)(void 0),(0,a.finalize)(()=>{e.callback&&typeof e.callback=="function"&&e.callback(i.id)})))}})()}};us=(0,r.__decorate)([(0,C.l)({type:"crt.CopilotRenameSessionHandler",requestType:"crt.CopilotRenameSessionRequest",scopes:["CopilotPanel"]}),(0,r.__metadata)("design:paramtypes",[Ke.o,V,y.DW,S.TranslateService])],us);let Xe=class ms{constructor(e){e.register(nt,Pe),e.register(nt,bn.T)}static{this.\u0275fac=function(t){return new(t||ms)(d.\u0275\u0275inject(Ps.s))}}static{this.\u0275mod=d.\u0275\u0275defineNgModule({type:ms})}static{this.\u0275inj=d.\u0275\u0275defineInjector({providers:[v.F,Q,I.d],imports:[ue,Ae,S.TranslateModule]})}};Xe=(0,r.__decorate)([(0,R.g)({viewElements:[],requestHandlers:[ct,ds,dt,hs,ht,ut,pt,mt,gt,St,vt,yt,It,Mt,At,Et,Pt,xt,bt,Tt,Rt,Nt,Qe,Lt,wt,Ft,Ut,Vt,Ot,Ht,jt,kt,Bt,zt,Gt,Jt,Qt,Xt,Zt,Yt,qt,es,ts,ss,ns,is,us,as,os,rs,cs,ls],converters:[it,at,ot,rt]}),(0,r.__metadata)("design:paramtypes",[Ps.s])],Xe),function(){(typeof ngJitMode>"u"||ngJitMode)&&d.\u0275\u0275setNgModuleScope(Xe,{imports:[ue,Ae,S.TranslateModule]})}()},11395:(H,M,l)=>{l.d(M,{P:()=>y});var r=l(22307),I=l.n(r),R=l(59247),S=l.n(R),v=l(23681),b=l.n(v),d=l(59969),T=l(97998),A=l(18046),L=l(19344),w=l(13232),a=l(12325),g=l(79772),E=l.n(g);class y{constructor(D,W,N,se,ee){this._dialogRef=D,this._dialogData=W,this._domPurifier=N,this._crtControlStateAdapter=se,this._injector=ee,this.chatTitleInputControl=new R.FormControl("",{validators:[this._crtControlStateAdapter.transform({instance:new T.Y(this._injector)})]})}get chatTitle(){return this._dialogData.chatTitle}onCloseButtonClicked(){this._dialogRef.close()}onSaveButtonClicked(){const D=this._domPurifier.sanitize(this.chatTitleInputControl.value)||"";D.trim()!==""&&this._dialogRef.close(D)}static{this.\u0275fac=function(W){return new(W||y)(r.\u0275\u0275directiveInject(v.MatDialogRef),r.\u0275\u0275directiveInject(v.MAT_DIALOG_DATA),r.\u0275\u0275directiveInject(d.MV),r.\u0275\u0275directiveInject(A.f),r.\u0275\u0275directiveInject(r.Injector))}}static{this.\u0275cmp=r.\u0275\u0275defineComponent({type:y,selectors:[["crt-rename-chat"]],decls:11,vars:20,consts:[[1,"rename-dialog-container"],["labelType","headline-3","labelColor","var(--crt-palette-secondary-500)",1,"dialog-title",3,"title","caption"],[1,"dialog-input",3,"keyup.enter","control","value","label","labelPosition","multiline"],[1,"dialog-actions"],["data-item-marker","closeButton",1,"cancel-button",3,"clicked","caption"],["color","primary","data-item-marker","saveButton",1,"save-button",3,"clicked","disabled","caption"]],template:function(W,N){W&1&&(r.\u0275\u0275elementStart(0,"div",0),r.\u0275\u0275element(1,"crt-label",1),r.\u0275\u0275pipe(2,"translate"),r.\u0275\u0275pipe(3,"translate"),r.\u0275\u0275elementStart(4,"crt-input",2),r.\u0275\u0275pipe(5,"translate"),r.\u0275\u0275listener("keyup.enter",function(){return N.onSaveButtonClicked()}),r.\u0275\u0275elementEnd(),r.\u0275\u0275elementStart(6,"div",3)(7,"crt-button",4),r.\u0275\u0275pipe(8,"translate"),r.\u0275\u0275listener("clicked",function(){return N.onCloseButtonClicked()}),r.\u0275\u0275elementEnd(),r.\u0275\u0275elementStart(9,"crt-button",5),r.\u0275\u0275pipe(10,"translate"),r.\u0275\u0275listener("clicked",function(){return N.onSaveButtonClicked()}),r.\u0275\u0275elementEnd()()()),W&2&&(r.\u0275\u0275advance(),r.\u0275\u0275property("title",r.\u0275\u0275pipeBind1(2,10,"ChatList.RenameChat.LabelTitle"))("caption",r.\u0275\u0275pipeBind1(3,12,"ChatList.RenameChat.LabelTitle")),r.\u0275\u0275advance(3),r.\u0275\u0275property("control",N.chatTitleInputControl)("value",N.chatTitle)("label",r.\u0275\u0275pipeBind1(5,14,"ChatList.RenameChat.InputTitle"))("labelPosition","above")("multiline",!0),r.\u0275\u0275advance(3),r.\u0275\u0275property("caption",r.\u0275\u0275pipeBind1(8,16,"ChatList.RenameChat.CancelButton")),r.\u0275\u0275advance(2),r.\u0275\u0275property("disabled",!N.chatTitleInputControl.valid)("caption",r.\u0275\u0275pipeBind1(10,18,"ChatList.RenameChat.SaveButton")))},dependencies:[L.j,w.B,a.V,g.TranslatePipe],styles:[".rename-dialog-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:16px}.dialog-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:8px}"]})}}},96158:(H,M,l)=>{l.d(M,{g:()=>r});var r;(function(I){I.TriggerMention="triggerMention",I.Focus="focus"})(r||(r={}))},37206:(H,M,l)=>{l.d(M,{D:()=>A,w:()=>L});var r=l(73308),I=l(81517),R=l(41287),S=l(91775),v=l(62278),b=l.n(v);const d="ChatsListLoadSubject",T="ChatsListLoadSubscription";class A extends I.S{constructor(){super(...arguments),this.searchFilter=null,this.isFirstLoad=!1}}class L extends R.l{_getChatsListLoadSubject(a){return(0,r.A)(function*(){let g=yield a.$context[d];return g||(g=new v.Subject,a.$context[d]=g),g})()}_resetChatsLoadOffsetSubscription(a){var g=this;(0,r.A)(function*(){const E=yield a.$context[T];E&&E.unsubscribe();const y=yield g._getChatsListLoadSubject(a);g._handleChatsListOffsetChange(a,y)})()}_handleChatsListOffsetChange(a,g){var E=this;a.$context[T]=g.pipe((0,v.debounceTime)(500),(0,v.tap)(()=>a.$context.IsActiveChatsLoading=!1),(0,v.distinctUntilChanged)((y,P)=>y.offset===P.offset&&y.searchFilter===P.searchFilter),(0,v.tap)(()=>a.$context.IsActiveChatsLoading=!0),(0,v.switchMap)(y=>this.getChatPreviews(y.offset,y.rowsToLoad,y.searchFilter).pipe((0,v.filter)(P=>y.offset===0||P&&P.length>0),(0,v.map)(P=>P.map(D=>this.mapChatPreview(D))),(0,v.switchMap)(P=>(0,v.from)(a.$context.ActiveChats).pipe((0,v.take)(1),(0,v.map)(D=>!D||D.length===0||y.currentPage===0?P:[...D,...P]))),(0,v.map)(P=>({page:y.currentPage,mappedSessions:P,search:y.searchFilter})),(0,v.finalize)(()=>{a.$context.IsActiveChatsLoading=!1})))).subscribe({next:y=>{a.$context.ActiveChats=Array.from(new Map(y.mappedSessions.map(P=>[P.id,P])).values()),a.$context.ChatsListPage=y.page+1,y.search&&(0,r.A)(function*(){return yield E._reloadCurrentChatIfNeeded(a)})()},error:y=>{console.error("Failed to load chat previews:",y),this._resetChatsLoadOffsetSubscription(a)}})}_reloadCurrentChatIfNeeded(a){var g=this;return(0,r.A)(function*(){const E=yield g.getCurrentChatId(a),y=yield a.$context.IsCombinedMode,P=(yield a.$context.ActiveChats).find(D=>D.id===E);if(P&&y){const D=g.getChatOpenRequest(a,P);yield S.t.instance.process(D)}})()}handle(a){var g=this;return(0,r.A)(function*(){yield g.next?.handle(a);const E=yield g._getChatsListLoadSubject(a);a.isFirstLoad&&(g._handleChatsListOffsetChange(a,E),a.$context.ChatsListPage=0);const y=yield a.$context.ChatsListPage,P=y*a.rowsToLoadCount;E.next({offset:P,rowsToLoad:a.rowsToLoadCount,currentPage:y,searchFilter:a.searchFilter})})()}}},13161:(H,M,l)=>{l.d(M,{j:()=>r});const r="ChatPanel"},43778:(H,M,l)=>{l.d(M,{R:()=>I,u:()=>r});class r{}const I="reset"},13555:(H,M,l)=>{l.d(M,{X:()=>d});var r=l(62278),I=l.n(r),R=l(36486),S=l.n(R),v=l(22307),b=l.n(v);class d{constructor(){this._saveMessageDebounceTimeout=500,this._storageKeyPrefix="chat-draft",this._draftUpdatesMap=new Map}_getOrCreateSubject(A){if(!this._draftUpdatesMap.has(A)){const L=new r.Subject;L.pipe((0,R.debounceTime)(this._saveMessageDebounceTimeout)).subscribe(w=>{const a=this._getStorageKey(A);w===null?sessionStorage.removeItem(a):sessionStorage.setItem(a,w)}),this._draftUpdatesMap.set(A,L)}return this._draftUpdatesMap.get(A)}_getStorageKey(A){return`${this._storageKeyPrefix}-${A||"new"}`}setDraft(A,L){this._getOrCreateSubject(A).next(L)}getDraft(A){const L=this._getStorageKey(A);return sessionStorage.getItem(L)||""}clearDraft(A){this._getOrCreateSubject(A).next(null)}ngOnDestroy(){this._draftUpdatesMap.forEach(A=>{A.complete()}),this._draftUpdatesMap.clear()}static{this.\u0275fac=function(L){return new(L||d)}}static{this.\u0275prov=v.\u0275\u0275defineInjectable({token:d,factory:d.\u0275fac,providedIn:"root"})}}},92385:(H,M,l)=>{l.d(M,{$:()=>w});var r=l(79772),I=l.n(r),R=l(34268),S=l.n(R),v=l(89986),b=l(22307),d=l.n(b),T=l(13555);const A=["span"],L=["class","data-mention"];class w{constructor(g,E){this._translateService=g,this._chatDraftService=E,this._domPurifier=S()(window),this._domPurifier.addHook("uponSanitizeElement",v.F.func)}_replaceMentions(g){if(!g.includes('class="mention"')&&!g.includes("class='mention'"))return g;const E=document.createElement("div");return E.innerHTML=g,E.querySelectorAll(".mention").forEach(y=>{const D=y.textContent||""||" ";y.replaceWith(document.createTextNode(D))}),E.innerHTML}_stripMarkdown(g){return g.replace(/\[([^\]]+)\]\([^)]+\)/g,"$1").replace(/\*\*(.*?)\*\*/g,"$1").replace(/\*(.*?)\*/g,"$1").replace(/__(.*?)__/g,"$1").replace(/_(.*?)_/g,"$1").replace(/`([^`]+?)`/g,"$1").replace(/^>+\s?/gm,"").replace(/^#{1,6}\s?/gm,"").replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&amp;/g,"&").replace(/\\n/g,`
`).replace(/\n{2,}/g,`

`).trim()}sanitizeContent(g){const E={ALLOWED_TAGS:A,ALLOWED_ATTR:L};return this._domPurifier.sanitize(g,E)}getPreview(g,E,y){if(!y)return this._translateService.instant("ChatList.YourPreview")+this.toPlainText(E);const P=this.sanitizeContent(this._chatDraftService.getDraft(g));return P&&P.length>0?this._translateService.instant("ChatList.DraftPreview")+this.toPlainText(P):this.toPlainText(E)}toPlainText(g){if(!g)return"";const E=this._replaceMentions(g);return this._stripMarkdown(E)}static{this.\u0275fac=function(E){return new(E||w)(b.\u0275\u0275inject(r.TranslateService),b.\u0275\u0275inject(T.X))}}static{this.\u0275prov=b.\u0275\u0275defineInjectable({token:w,factory:w.\u0275fac,providedIn:"root"})}}},89986:(H,M,l)=>{l.d(M,{F:()=>r});const r={name:"uponSanitizeElement",func:(I,R)=>{if(R.tagName==="span"){const S=I.getAttribute("class"),v=I.getAttribute("data-mention");if(!(S==="mention"&&v)){const d=document.createTextNode(I.textContent||"");I.parentNode?.replaceChild(d,I)}}}}},20555:(H,M,l)=>{l.d(M,{bd:()=>R,kl:()=>r,ll:()=>I});const r="OpenChatSessionEvent",I="OpenChatSessionWithMessageEvent",R="Copilot"},85040:(H,M,l)=>{l.d(M,{u:()=>r});var r;(function(I){I.SetHighlighting="setHighlighting",I.RemoveHighlighting="removeHighlighting"})(r||(r={}))},48534:(H,M,l)=>{l.d(M,{i:()=>b});var r=l(62278),I=l.n(r),R=l(85040),S=l(22307),v=l.n(S);class b{constructor(){this._currentSubscriptionIdentifier=null,this._currentSubscription=null,this._replaceSelectionSubject=new r.Subject}_unsubscribeLastEditor(){if(this._currentSubscription){const T={editorAction:R.u.RemoveHighlighting};this._replaceSelectionSubject?.next(T),this._currentSubscriptionIdentifier=null,this._currentSubscription.unsubscribe()}}subscribeToNotifications(T,A){this._currentSubscriptionIdentifier!==T&&(this._unsubscribeLastEditor(),this._currentSubscriptionIdentifier=T,this._currentSubscription=this._replaceSelectionSubject.subscribe(A))}notify(T){this._replaceSelectionSubject?.next(T)}static{this.\u0275fac=function(A){return new(A||b)}}static{this.\u0275prov=S.\u0275\u0275defineInjectable({token:b,factory:b.\u0275fac,providedIn:"root"})}}},63740:(H,M,l)=>{l.d(M,{p:()=>I});var r=l(6530);class I{constructor(S){S&&(this.uId=S.uId,this.name=S.name,this.parentSchemaUId=S.parentSchemaUId),this.uId=this.uId||(0,r.qv)()}update(S){this.uId=S.uId,this.name=S.name}equal(S){if(S==null)return!1;let v=this.uId===S.uId&&this.name===S.name;return(this.parentSchemaUId||S.parentSchemaUId)&&(v=v&&this.parentSchemaUId===S.parentSchemaUId),v}clone(){return new I(this)}getLocalizableValues(S){}loadLocalizableValues(S,v=!1){}}},37827:(H,M,l)=>{l.d(M,{e:()=>R});var r=l(50588),I=l(63740);class R extends I.p{constructor(v){super(v),this.values=new r.h(v?.values)}clone(){return new R(this)}getLocalizableValues(v){super.getLocalizableValues(v),v.values=this.values.clone()}loadLocalizableValues(v,b=!1){super.loadLocalizableValues(v,b),this.values.setValues(v.values,b)}}}}]);
