(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[5900],{33429:(D,O,r)=>{r.d(O,{K:()=>_});var u=r(73308),v=r(5757),E=r.n(v),d=r(40269),m=r(62278),p=r.n(m),c=r(36486),l=r.n(c),M=r(22307),y=r.n(M);class _{constructor(t){this._http=t,this._serviceUrl="/rest/LanguageTranslationService/",this._languagesCache=null}_post(t,n){const o=this._serviceUrl+t;return this._http.post(o,n)}_getLanguages(){return(0,u.A)(function*(){return(yield(yield d.K.create("SysLanguage")).load({attributes:["Code","Name"]})).map(C=>({value:C.Id,code:C.Code,displayValue:C.Name}))})()}getAvailableTranslationLanguages(){return this._languagesCache?.length>0?(0,m.of)(this._languagesCache):(0,m.from)(this._getLanguages()).pipe((0,c.map)(t=>t.sort((n,o)=>n.displayValue.localeCompare(o.displayValue))),(0,c.tap)(t=>this._languagesCache=t),(0,c.catchError)(()=>(this._languagesCache=[],(0,m.of)(this._languagesCache))))}translateText(t,n="",o=""){return this._post("TranslateText",{text:t,sourceLanguage:n,targetLanguage:o}).pipe((0,c.catchError)(C=>{throw console.error("Translation error:",C),C}))}translateTextWithSourceLanguageDetecting(t,n=""){return this._post("TranslateTextWithSourceLanguageDetecting",{text:t,targetLanguage:n}).pipe((0,c.catchError)(o=>{throw console.error("Language detection error:",o),o}))}static{this.\u0275fac=function(n){return new(n||_)(M.\u0275\u0275inject(v.HttpClient))}}static{this.\u0275prov=M.\u0275\u0275defineInjectable({token:_,factory:_.\u0275fac,providedIn:"root"})}}},43272:(D,O,r)=>{r.d(O,{A:()=>y});var u=r(18587),v=r(49973),E=r(58504),d=r(74709),m=r(43785),p=r(62278),c=r.n(p),l=r(36486),M=r.n(l);class y{constructor(a,t,n){this.queryExecutor=a,this._translateService=t,this.entityConverter=n,this.absentDataErrorKey="BaseSection.AbsentDataErrorMessage",this.primaryColumnName="Id"}_convertToErrorInfo(a){return{errorCode:null,message:a.message,stackTrace:a.stack}}_addColumnsToEsq(a){this.entityConverter.getEntityColumns({}).forEach(n=>{a.addSchemaColumn(n.path)})}_createDeleteQuery(){return new u.x(this.entitySchemaName)}getBaseErrorResponse(a){return(0,p.of)({success:!1,errorInfo:this._convertToErrorInfo(a),result:null})}handleResponse(a){return a.pipe((0,l.map)(()=>({success:!0,errorInfo:null,result:[]})),(0,l.catchError)(t=>(0,p.of)({success:!1,errorInfo:this._convertToErrorInfo(t),result:[]})))}getItemByIdEsq(a){const t=new v.s(this.entitySchemaName);return this._addColumnsToEsq(t),t.filters.addSchemaColumnFilterWithParameter(E.H.Equal,this.primaryColumnName,a),t}createGetAllItemsEsq(){const a=new v.s(this.entitySchemaName);return this._addColumnsToEsq(a),a}getUpdateQuery(a){const t=new d.N(this.entitySchemaName);return this.entityConverter.getEntityColumns(a).forEach(o=>{this.primaryColumnName===o.path?t.filters.addSchemaColumnFilterWithParameter(E.H.Equal,this.primaryColumnName,o.value):t.addColumn(o.path,o.value,o.type)}),t}getInsertQuery(a){const t=new m.L(this.entitySchemaName);return this.entityConverter.getEntityColumns(a).forEach(o=>{this.primaryColumnName===o.path&&!o.value||t.addColumn(o.path,o.value,o.type)}),t}getDeleteQuery(a){return this.getDeleteQueryWithPrimaryColumnFilter(a.id)}getDeleteQueryWithPrimaryColumnFilter(a){const t=this._createDeleteQuery();return t.filters.addSchemaColumnFilterWithParameter(E.H.Equal,this.primaryColumnName,a),t}loadAdditionalInfo(a){return(0,p.of)(a)}getItems(){const a=this.createGetAllItemsEsq();return this.queryExecutor.executeSelectQuery(a).pipe((0,l.mergeMap)(t=>this.loadAdditionalInfo(t)),(0,l.map)(t=>({success:!0,errorInfo:null,result:t.map(n=>this.entityConverter.getEntity(n))})),(0,l.catchError)(t=>this.getBaseErrorResponse(t)))}getItem(a){const t=this.getItemByIdEsq(a);return this.queryExecutor.executeSelectQuery(t).pipe((0,l.tap)(n=>{if(!(n&&n[0])){const o=this._translateService.instant(this.absentDataErrorKey);throw new Error(o)}}),(0,l.mergeMap)(n=>this.loadAdditionalInfo(n)),(0,l.map)(n=>({success:!0,errorInfo:null,result:[this.entityConverter.getEntity(n[0])]})),(0,l.catchError)(n=>this.getBaseErrorResponse(n)))}insertItem(a){const t=this.getInsertQuery(a),n=this.queryExecutor.executeInsertQuery(t);return this.handleResponse(n)}updateItem(a){const t=this.getUpdateQuery(a),n=this.queryExecutor.executeUpdateQuery(t);return this.handleResponse(n)}deleteItem(a){const t=this.getDeleteQuery(a),n=this.queryExecutor.executeDeleteQuery(t);return this.handleResponse(n)}deleteById(a){const t=this.getDeleteQueryWithPrimaryColumnFilter(a),n=this.queryExecutor.executeDeleteQuery(t);return this.handleResponse(n)}}},56704:(D,O,r)=>{r.d(O,{I:()=>g});var u=r(5757),v=r.n(u),E=r(49973),d=r(58504),m=r(41108),p=r(56267),c=r(79772),l=r.n(c),M=r(43272),y=r(23872),_=r(62278),a=r.n(_),t=r(36486),n=r.n(t),o=r(22307),C=r.n(o),f=r(50485),A=r(65751),T=r(14876),U=r(23092);class g extends M.A{static get rowsCount(){return 30}constructor(e,s,i,h,P,I){super(s,i,h),this.rightsService=e,this.httpClient=P,this.userInfo=I,this._serviceUrl="/rest/OmnichannelChatService/",this._canManageChatsOperationCode="CanManageChats",this._cacheChatActions={},this.entitySchemaName="OmniChat"}_postWithChatId(e,s){const i=this._serviceUrl+s;return this.httpClient.post(i,{chatId:e})}_getMessages(e,s){const i=this._serviceUrl+s;return this.httpClient.post(i,{chatId:e}).pipe((0,t.map)(this._mapChatMessage()))}_getAllConversationMessages(e,s,i,h){const P=new u.HttpHeaders().set("Content-Type","application/json; charset=utf-8"),I=this._serviceUrl+"GetAllConversation";return this.httpClient.post(I,{contactId:e,channelId:s,rowCount:g.rowsCount,rowOffset:i,translationLanguageCode:h},{headers:P}).pipe((0,t.map)(this._mapChatMessage()))}_mapChatMessage(){return e=>(e.forEach(s=>{s.time=new Date(s.time),s.author=new y.B(s.author.id,s.author.name,s.author.photoId),s.macrosTemplate&&this._handleMessageMacros(s)}),e)}_handleMessageMacros(e){let s;try{s=JSON.parse(e.macrosTemplate.tokens)}catch(i){console.error("Failed to parse tokens:",i)}e.macrosTemplate.tokens=s}acceptChat(e){return this._postWithChatId(e,"AcceptChat")}getAllConversationByChat(e,s=0){const i=new u.HttpHeaders().set("Content-Type","application/json; charset=utf-8"),h=this._serviceUrl+"GetAllConversationByChat";return this.httpClient.post(h,{chatId:e,rowCount:g.rowsCount,rowOffset:s},{headers:i}).pipe((0,t.map)(this._mapChatMessage()))}getAllConversation(e,s,i=0,h=null){return this._getAllConversationMessages(e,s,i,h)}getConversation(e){const s=new u.HttpHeaders().set("Content-Type","application/json; charset=utf-8"),i=this._serviceUrl+"GetConversation";return this.httpClient.post(i,{chatId:e},{headers:s}).pipe((0,t.map)(this._mapChatMessage()))}markAsRead(e){const s=this._serviceUrl+"MarkChatAsRead";this.httpClient.post(s,{chatId:e}).subscribe()}getMessageTemplate(e){const s=this._serviceUrl+"GetUnifiedMessageTemplate";return this.httpClient.post(s,{chatId:e})}getPreviousChatId(e){const s=this._serviceUrl+"GetPreviousChatId";return this.httpClient.post(s,{chatId:e})}sendMessage(e){const s="/rest/OmnichannelOutcomeMessagingService/SendMessage",i={message:e};return this.httpClient.post(s,i)}sendMessageWithAttachments(e,s){const i="/rest/OmnichannelOutcomeMessagingService/SendMessageWithAttachments",h=new FormData;return h.append("message",JSON.stringify(e)),Array.from(s).forEach((P,I)=>{h.append("file"+I,P,P.name)}),this.httpClient.post(i,h)}completeChat(e){return this._postWithChatId(e,"CloseActiveChat")}getOperatorChats(){const e=this._serviceUrl+"GetChats";return this.httpClient.post(e,{operatorId:this.userInfo.id}).pipe((0,t.map)(s=>({success:!0,errorInfo:null,result:s.Chats.map(i=>this.entityConverter.getEntity(i))})),(0,t.catchError)(s=>this.getBaseErrorResponse(s)))}getDirectedChats(){const e=this._serviceUrl+"GetDirectedChats";return this.httpClient.post(e,{operatorId:this.userInfo.id})}getChatHistory(e){return this._getMessages(e,"GetHistory")}getChatActions(e){if(this._cacheChatActions[e])return(0,_.of)(this._cacheChatActions[e]);const s=this._serviceUrl+"GetChatActions";return this.httpClient.post(s,{chatId:e}).pipe((0,t.tap)(i=>this._cacheChatActions[e]=i))}isOperatorCanManageChats(){return this.rightsService.getCanExecuteOperation(this._canManageChatsOperationCode).pipe((0,t.map)(e=>e))}isOperatorActive(){const e=new E.s("OperatorSession");return e.rowCount=1,e.addSchemaColumn("OperatorState.OperatorAvailable","IsActive"),e.filters.addSchemaColumnFilterWithParameter(d.H.Is_null,"SessionEndDate",null),e.filters.addSchemaColumnFilterWithParameter(d.H.Equal,"SysUser",this.userInfo.id),this.queryExecutor.executeSelectQuery(e).pipe((0,t.map)(s=>s&&s[0].IsActive||!1),(0,t.catchError)(()=>(0,_.of)(!1)))}isOperatorHasActiveChannel(){const e=new E.s("Channel");e.rowCount=1;const s=new m.X;return s.logicalOperation=p.H.Or,s.addSchemaColumnFilterWithParameter(d.H.Equal,"ChatQueue.[ChatQueueOperator:ChatQueue:Id].[SysAdminUnitInRole:SysAdminUnit:Operator].SysAdminUnit",this.userInfo.id),s.addSchemaColumnFilterWithParameter(d.H.Equal,"ChatQueue.[ChatQueueOperator:ChatQueue:Id].[SysAdminUnitInRole:SysAdminUnitRoleId:Operator].SysAdminUnit",this.userInfo.id),e.filters.add(s),e.filters.addSchemaColumnFilterWithParameter(d.H.Equal,"IsActive",!0),this.queryExecutor.executeSelectQuery(e).pipe((0,t.map)(i=>i&&i.length>0||!1),(0,t.catchError)(()=>(0,_.of)(!1)))}hasUncompletedChats(e){const s=this._serviceUrl+"GetHasUncompletedChats";return this.httpClient.post(s,{channelId:e})}translateChatMessages(e,s,i){return this.httpClient.post("/rest/OmniChatTranslationService/TranslateChat",{chatId:e,sourceLanguage:s,targetLanguage:i}).pipe((0,t.map)(h=>h))}static{this.\u0275fac=function(s){return new(s||g)(o.\u0275\u0275inject(f.f),o.\u0275\u0275inject(A.w),o.\u0275\u0275inject(c.TranslateService),o.\u0275\u0275inject(T.K),o.\u0275\u0275inject(u.HttpClient),o.\u0275\u0275inject(U.oq))}}static{this.\u0275prov=o.\u0275\u0275defineInjectable({token:g,factory:g.\u0275fac,providedIn:"root"})}}}}]);
